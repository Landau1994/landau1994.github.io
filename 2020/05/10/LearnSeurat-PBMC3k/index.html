<!DOCTYPE HTML>
<html class="no-js" lang="zh-CN">
<head>
    <!--[if lte IE 9]>
<meta http-equiv="refresh" content="0;url=https://landau1994.github.io/warn.html">
<![endif]-->
<meta charset="utf-8">
<meta http-equiv="X-DNS-Prefetch-Control" content="on">
<link rel="dns-prefetch" href="https://landau1994.github.io">
<link rel="dns-prefetch" href="//www.google-analytics.com">
<link rel="prefetch" href="https://landau1994.github.io">
<link rel="prefetch" href="//www.google-analytics.com">


<link rel="prerender" href="https://landau1994.github.io">

<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no">
<meta http-equiv="mobile-agent" content="format=html5; url=https://landau1994.github.io">
<meta name="author" content="Longteng Wang">

<link rel="stylesheet" href="/css/JSimple.css">


<link rel="shortcut icon" href="/images/favicon.png">


<title>learnseurat_pbmc3k - Coding for Life Sciences</title>

<meta name="keywords" content="Biology, Data Science,AI,Informatics,Modeling;">

<meta name="description " content="LearnSeurat_1">

    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                processEscapes: true
            }
        });
    </script>



  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: 'default',
      flowchart: {
        useMaxWidth: false
      }
    });
  </script>

    

    

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"] > svg a {
  fill: blue;
  stroke: blue;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container {
  overflow: auto hidden;
}

mjx-container + br {
  display: none;
}
</style></head>
<body>
<div id="nav">
    <nav class="nav-menu">
        <a class="site-name current" href="/" title="CLS">CLS</a>
        <a class="site-index current" href="/"><i class="fa fa-home"></i><span>首页</span></a>
        <a href="/archives" title="归档"><i class="fa fa-archives"></i><span>归档</span></a>
        <a href="/tags" title="标签"><i class="fa fa-tags"></i><span>标签</span></a>
        <!-- custom single page of menus -->
        
        
        <a href="/help" title="帮助">
            <i class="fa fa-question-circle"></i>
            <span>帮助</span>
        </a>
        
    </nav>
</div>

<div class="nav-user">
    <a class="btn-search" href="#"><i class="fa fa-search"></i></a>
    <a class="btn-read-mode" href="#"><i class="fa fa-sun-o"></i></a>
    <a class="btn-sns-qr" href="javascript:"><i class="fa fa-telegram"></i></a>
</div>

<div id="wrapper" class="clearfix">
    <div id="body">
        <div class="main" id="main">
            <div id="cover">
    <div class="cover-img"></div>
    <div class="cover-info">
        
        <h1 class="cover-siteName">Coding for Life Science</h1>
        <h3 class="cover-siteTitle">Coding for Life Science</h3>
        <p class="cover-siteDesc">关注从数据和模型中获取生物知识的博客</p>
        <div class="cover-sns">
            
    &nbsp;&nbsp;<div class="btn btn-telegram">
        <a href="" target="_blank" title="telegram" ref="friend">
            <i class="fa fa-telegram"></i>
        </a>
    </div>

    &nbsp;&nbsp;<div class="btn btn-instagram">
        <a href="" target="_blank" title="instagram" ref="friend">
            <i class="fa fa-instagram"></i>
        </a>
    </div>

    &nbsp;&nbsp;<div class="btn btn-twitter">
        <a href="https://twitter.com/Landau1994" target="_blank" title="twitter" ref="friend">
            <i class="fa fa-twitter"></i>
        </a>
    </div>

    &nbsp;&nbsp;<div class="btn btn-github">
        <a href="https://github.com/Landau1994" target="_blank" title="github" ref="friend">
            <i class="fa fa-github"></i>
        </a>
    </div>


        </div>
    </div>
</div>

            <div class="page-title">
    <ul>
        <li><a href="/">最近</a></li>
        
            
                <li class="">
                    <a href="/categories/genomics" data-name="基因组学">基因组学</a>
                </li>
            
                <li class="">
                    <a href="/categories/implementation" data-name="编程实践">编程实践</a>
                </li>
            
                <li class="">
                    <a href="/categories/reference" data-name="文献阅读">文献阅读</a>
                </li>
            
                <li class="">
                    <a href="/categories/math" data-name="数学学习">数学学习</a>
                </li>
            
                <li class="">
                    <a href="/categories/others" data-name="其他">其他</a>
                </li>
            
        
        <li class="page-search">
    <form id="search" class="search-form">
        <input type="text"
               readonly="readonly"
               id="local-search-input-tip"
               placeholder="读物检索~" />
        <button type="button" disabled="disabled" class="search-form-submit"><i class="fa fa-search"></i></button>
    </form>
</li>

    </ul>
</div>
<div class="main-inner">
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
        <div class="post-header">
            <div class="post-author clearfix">
                <a class="avatar fleft" href="https://github.com/Landau1994"
                   target="_blank">
                    <img width="48" src="/images/faceicon.png" alt="avatar"/>
                </a>
                <p><span class="label">作者</span>
                    <a href="https://github.com/Landau1994"
                       target="_blank">夏目沉吟</a>
                    <span title="最后编辑于&nbsp;2020-05-10">2020-05-10</span>
                </p>
                <p>A PhD student in bioinformatics</p>
            </div>
            <h2 class="post-title">LearnSeurat_PBMC3k</h2>
            <div class="post-meta">
                本文共计45616个字 |
                您是第&nbsp;<span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span>位看到它们的小伙伴
            </div>
        </div>
        <div class="post-content markdown-body">
            <p>本系列假定读者对于单细胞测序的数据分析和Seurat的官方教程有所了解。</p>
<p>本篇研究最基础的PBMC3k。其实这里只有2700个外周血的细胞。注意到，由于取样是外周血，没有干细胞的存在，所以可以认为样品处于稳态。这个教程就是讲稳态下的单细胞测序分析是如何进行的。Seurat的官方教程的缺点之一就是没有涉及动态过程的单细胞分析如何进行。</p>
<p>如无特殊说明，本系列的代码均可以在自己的笔记本电脑上运行；</p>
<h3 id="构建seurat-object">1. 构建Seurat object</h3>
<p>使用作者已经构建好的数据进行构建。关于Seurat更详细的文档可见<a target="_blank" rel="noopener" href="https://github.com/satijalab/seurat/wiki">satijalab的wiki</a></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">library</span>(Seurat)</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">library</span>(SeuratData)</a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw">library</span>(ggplot2)</a>
<a class="sourceLine" id="cb1-4" title="4"><span class="kw">library</span>(igraph)</a>
<a class="sourceLine" id="cb1-5" title="5"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb1-6" title="6"><span class="kw">library</span>(patchwork)</a>
<a class="sourceLine" id="cb1-7" title="7"><span class="co">### AvailableData() check avaliable data: we choose cbmc</span></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="co">### InstallData('pbmc3k')</span></a>
<a class="sourceLine" id="cb1-9" title="9"><span class="kw">library</span>(pbmc3k.SeuratData)</a>
<a class="sourceLine" id="cb1-10" title="10"></a>
<a class="sourceLine" id="cb1-11" title="11"><span class="co">### how this dataset generate?</span></a>
<a class="sourceLine" id="cb1-12" title="12"><span class="co"># ## Not run: </span></a>
<a class="sourceLine" id="cb1-13" title="13"><span class="co"># if (requireNamespace(Seurat, quietly = TRUE)) {</span></a>
<a class="sourceLine" id="cb1-14" title="14"><span class="co">#   url &lt;- 'http://cf.10xgenomics.com/samples/cell-exp/1.1.0/pbmc3k/pbmc3k_filtered_gene_bc_matrices.tar.gz'</span></a>
<a class="sourceLine" id="cb1-15" title="15"><span class="co">#   curl::curl_download(url = url, destfile = basename(path = url))</span></a>
<a class="sourceLine" id="cb1-16" title="16"><span class="co">#   untar(tarfile = basename(path = url))</span></a>
<a class="sourceLine" id="cb1-17" title="17"><span class="co">#   pbmc.data &lt;- Seurat::Read10X(data.dir = 'filtered_gene_bc_matrices/hg19/')</span></a>
<a class="sourceLine" id="cb1-18" title="18"><span class="co">#   pbmc3k &lt;- Seurat::CreateSeuratObject(counts = pbmc.data, project = 'pbmc3k', min.cells = 3, min.features = 200)</span></a>
<a class="sourceLine" id="cb1-19" title="19"><span class="co">#   # Annotations come from Seurat's PBMC3k Guided Clustering Tutorial</span></a>
<a class="sourceLine" id="cb1-20" title="20"><span class="co">#   # https://satijalab.org/seurat/v3.0/pbmc3k_tutorial.html</span></a>
<a class="sourceLine" id="cb1-21" title="21"><span class="co">#   annotations &lt;- readRDS(file = system.file('extdata/annotations/annotations.Rds', package = 'pbmc3k.SeuratData'))</span></a>
<a class="sourceLine" id="cb1-22" title="22"><span class="co">#   pbmc3k &lt;- Seurat::AddMetaData(object = pbmc3k, metadata = annotations)</span></a>
<a class="sourceLine" id="cb1-23" title="23"><span class="co">#   # Clean up downloaded files</span></a>
<a class="sourceLine" id="cb1-24" title="24"><span class="co">#   file.remove(basename(path = url))</span></a>
<a class="sourceLine" id="cb1-25" title="25"><span class="co">#   unlink(x = 'filtered_gene_bc_matrices/', recursive = TRUE)</span></a>
<a class="sourceLine" id="cb1-26" title="26"><span class="co"># }</span></a>
<a class="sourceLine" id="cb1-27" title="27"><span class="co"># </span></a>
<a class="sourceLine" id="cb1-28" title="28"><span class="co"># ## End(Not run)</span></a>
<a class="sourceLine" id="cb1-29" title="29"></a>
<a class="sourceLine" id="cb1-30" title="30"><span class="co">### how Create Seurat object work?</span></a>
<a class="sourceLine" id="cb1-31" title="31"><span class="co">### by run `Seurat::CreateSeuratObject` you can get the source function</span></a>
<a class="sourceLine" id="cb1-32" title="32"><span class="co"># ## Not run:</span></a>
<a class="sourceLine" id="cb1-33" title="33"><span class="co"># Seurat::CreateSeuratObject</span></a>
<a class="sourceLine" id="cb1-34" title="34"><span class="co"># function (counts, project = "SeuratProject", assay = "RNA", </span></a>
<a class="sourceLine" id="cb1-35" title="35"><span class="co">#     min.cells = 0, min.features = 0, names.field = 1, names.delim = "_", </span></a>
<a class="sourceLine" id="cb1-36" title="36"><span class="co">#     meta.data = NULL) </span></a>
<a class="sourceLine" id="cb1-37" title="37"><span class="co"># {</span></a>
<a class="sourceLine" id="cb1-38" title="38"><span class="co">#     if (!is.null(x = meta.data)) {</span></a>
<a class="sourceLine" id="cb1-39" title="39"><span class="co">#         if (is.null(x = rownames(x = meta.data))) {</span></a>
<a class="sourceLine" id="cb1-40" title="40"><span class="co">#             stop("Row names not set in metadata. Please ensure that rownames of metadata match column names of data matrix")</span></a>
<a class="sourceLine" id="cb1-41" title="41"><span class="co">#         }</span></a>
<a class="sourceLine" id="cb1-42" title="42"><span class="co">#         if (length(x = setdiff(x = rownames(x = meta.data), y = colnames(x = counts)))) {</span></a>
<a class="sourceLine" id="cb1-43" title="43"><span class="co">#             warning("Some cells in meta.data not present in provided counts matrix.")</span></a>
<a class="sourceLine" id="cb1-44" title="44"><span class="co">#             meta.data &lt;- meta.data[intersect(x = rownames(x = meta.data), </span></a>
<a class="sourceLine" id="cb1-45" title="45"><span class="co">#                 y = colnames(x = counts)), ]</span></a>
<a class="sourceLine" id="cb1-46" title="46"><span class="co">#         }</span></a>
<a class="sourceLine" id="cb1-47" title="47"><span class="co">#         if (is.data.frame(x = meta.data)) {</span></a>
<a class="sourceLine" id="cb1-48" title="48"><span class="co">#             new.meta.data &lt;- data.frame(row.names = colnames(x = counts))</span></a>
<a class="sourceLine" id="cb1-49" title="49"><span class="co">#             for (ii in 1:ncol(x = meta.data)) {</span></a>
<a class="sourceLine" id="cb1-50" title="50"><span class="co">#                 new.meta.data[rownames(x = meta.data), colnames(x = meta.data)[ii]] &lt;- meta.data[, </span></a>
<a class="sourceLine" id="cb1-51" title="51"><span class="co">#                   ii, drop = FALSE]</span></a>
<a class="sourceLine" id="cb1-52" title="52"><span class="co">#             }</span></a>
<a class="sourceLine" id="cb1-53" title="53"><span class="co">#             meta.data &lt;- new.meta.data</span></a>
<a class="sourceLine" id="cb1-54" title="54"><span class="co">#         }</span></a>
<a class="sourceLine" id="cb1-55" title="55"><span class="co">#     }</span></a>
<a class="sourceLine" id="cb1-56" title="56"><span class="co">#     assay.data &lt;- CreateAssayObject(counts = counts, min.cells = min.cells, </span></a>
<a class="sourceLine" id="cb1-57" title="57"><span class="co">#         min.features = min.features)</span></a>
<a class="sourceLine" id="cb1-58" title="58"><span class="co">#     Key(object = assay.data) &lt;- paste0(tolower(x = assay), "_")</span></a>
<a class="sourceLine" id="cb1-59" title="59"><span class="co">#     assay.list &lt;- list(assay.data)</span></a>
<a class="sourceLine" id="cb1-60" title="60"><span class="co">#     names(x = assay.list) &lt;- assay</span></a>
<a class="sourceLine" id="cb1-61" title="61"><span class="co">#     init.meta.data &lt;- data.frame(row.names = colnames(x = assay.list[[assay]]))</span></a>
<a class="sourceLine" id="cb1-62" title="62"><span class="co">#     idents &lt;- factor(x = unlist(x = lapply(X = colnames(x = assay.data), </span></a>
<a class="sourceLine" id="cb1-63" title="63"><span class="co">#         FUN = ExtractField, field = names.field, delim = names.delim)))</span></a>
<a class="sourceLine" id="cb1-64" title="64"><span class="co">#     if (any(is.na(x = idents))) {</span></a>
<a class="sourceLine" id="cb1-65" title="65"><span class="co">#         warning("Input parameters result in NA values for initial cell identities. Setting all initial idents to the project name")</span></a>
<a class="sourceLine" id="cb1-66" title="66"><span class="co">#     }</span></a>
<a class="sourceLine" id="cb1-67" title="67"><span class="co">#     ident.levels &lt;- length(x = unique(x = idents))</span></a>
<a class="sourceLine" id="cb1-68" title="68"><span class="co">#     if (ident.levels &gt; 100 || ident.levels == 0 || ident.levels == </span></a>
<a class="sourceLine" id="cb1-69" title="69"><span class="co">#         length(x = idents)) {</span></a>
<a class="sourceLine" id="cb1-70" title="70"><span class="co">#         idents &lt;- rep.int(x = factor(x = project), times = ncol(x = assay.data))</span></a>
<a class="sourceLine" id="cb1-71" title="71"><span class="co">#     }</span></a>
<a class="sourceLine" id="cb1-72" title="72"><span class="co">#     names(x = idents) &lt;- colnames(x = assay.data)</span></a>
<a class="sourceLine" id="cb1-73" title="73"><span class="co">#     object &lt;- new(Class = "Seurat", assays = assay.list, </span></a>
<a class="sourceLine" id="cb1-74" title="74"><span class="co">#         meta.data = init.meta.data, active.assay = assay, active.ident = idents, </span></a>
<a class="sourceLine" id="cb1-75" title="75"><span class="co">#         project.name = project, version = packageVersion(pkg = "Seurat"))</span></a>
<a class="sourceLine" id="cb1-76" title="76"><span class="co">#     object[["orig.ident"]] &lt;- idents</span></a>
<a class="sourceLine" id="cb1-77" title="77"><span class="co">#     n.calc &lt;- CalcN(object = assay.data)</span></a>
<a class="sourceLine" id="cb1-78" title="78"><span class="co">#     if (!is.null(x = n.calc)) {</span></a>
<a class="sourceLine" id="cb1-79" title="79"><span class="co">#         names(x = n.calc) &lt;- paste(names(x = n.calc), assay, </span></a>
<a class="sourceLine" id="cb1-80" title="80"><span class="co">#             sep = "_")</span></a>
<a class="sourceLine" id="cb1-81" title="81"><span class="co">#         object[[names(x = n.calc)]] &lt;- n.calc</span></a>
<a class="sourceLine" id="cb1-82" title="82"><span class="co">#     }</span></a>
<a class="sourceLine" id="cb1-83" title="83"><span class="co">#     if (!is.null(x = meta.data)) {</span></a>
<a class="sourceLine" id="cb1-84" title="84"><span class="co">#         object &lt;- AddMetaData(object = object, metadata = meta.data)</span></a>
<a class="sourceLine" id="cb1-85" title="85"><span class="co">#     }</span></a>
<a class="sourceLine" id="cb1-86" title="86"><span class="co">#     return(object)</span></a>
<a class="sourceLine" id="cb1-87" title="87"><span class="co"># }</span></a>
<a class="sourceLine" id="cb1-88" title="88"><span class="co"># </span></a>
<a class="sourceLine" id="cb1-89" title="89"><span class="co"># Seurat:: CreateAssayObject</span></a>
<a class="sourceLine" id="cb1-90" title="90"><span class="co"># function (counts, data, min.cells = 0, min.features = 0) </span></a>
<a class="sourceLine" id="cb1-91" title="91"><span class="co"># {</span></a>
<a class="sourceLine" id="cb1-92" title="92"><span class="co">#     if (missing(x = counts) &amp;&amp; missing(x = data)) {</span></a>
<a class="sourceLine" id="cb1-93" title="93"><span class="co">#         stop("Must provide either 'counts' or 'data'")</span></a>
<a class="sourceLine" id="cb1-94" title="94"><span class="co">#     }</span></a>
<a class="sourceLine" id="cb1-95" title="95"><span class="co">#     else if (!missing(x = counts) &amp;&amp; !missing(x = data)) {</span></a>
<a class="sourceLine" id="cb1-96" title="96"><span class="co">#         stop("Either 'counts' or 'data' must be missing; both cannot be provided")</span></a>
<a class="sourceLine" id="cb1-97" title="97"><span class="co">#     }</span></a>
<a class="sourceLine" id="cb1-98" title="98"><span class="co">#     else if (!missing(x = counts)) {</span></a>
<a class="sourceLine" id="cb1-99" title="99"><span class="co">#         if (anyDuplicated(rownames(x = counts))) {</span></a>
<a class="sourceLine" id="cb1-100" title="100"><span class="co">#             warning("Non-unique features (rownames) present in the input matrix, making unique", </span></a>
<a class="sourceLine" id="cb1-101" title="101"><span class="co">#                 call. = FALSE, immediate. = TRUE)</span></a>
<a class="sourceLine" id="cb1-102" title="102"><span class="co">#             rownames(x = counts) &lt;- make.unique(names = rownames(x = counts))</span></a>
<a class="sourceLine" id="cb1-103" title="103"><span class="co">#         }</span></a>
<a class="sourceLine" id="cb1-104" title="104"><span class="co">#         if (anyDuplicated(colnames(x = counts))) {</span></a>
<a class="sourceLine" id="cb1-105" title="105"><span class="co">#             warning("Non-unique cell names (colnames) present in the input matrix, making unique", </span></a>
<a class="sourceLine" id="cb1-106" title="106"><span class="co">#                 call. = FALSE, immediate. = TRUE)</span></a>
<a class="sourceLine" id="cb1-107" title="107"><span class="co">#             colnames(x = counts) &lt;- make.unique(names = colnames(x = counts))</span></a>
<a class="sourceLine" id="cb1-108" title="108"><span class="co">#         }</span></a>
<a class="sourceLine" id="cb1-109" title="109"><span class="co">#         if (is.null(x = colnames(x = counts))) {</span></a>
<a class="sourceLine" id="cb1-110" title="110"><span class="co">#             stop("No cell names (colnames) names present in the input matrix")</span></a>
<a class="sourceLine" id="cb1-111" title="111"><span class="co">#         }</span></a>
<a class="sourceLine" id="cb1-112" title="112"><span class="co">#         if (any(rownames(x = counts) == "")) {</span></a>
<a class="sourceLine" id="cb1-113" title="113"><span class="co">#             stop("Feature names of counts matrix cannot be empty", </span></a>
<a class="sourceLine" id="cb1-114" title="114"><span class="co">#                 call. = FALSE)</span></a>
<a class="sourceLine" id="cb1-115" title="115"><span class="co">#         }</span></a>
<a class="sourceLine" id="cb1-116" title="116"><span class="co">#         if (nrow(x = counts) &gt; 0 &amp;&amp; is.null(x = rownames(x = counts))) {</span></a>
<a class="sourceLine" id="cb1-117" title="117"><span class="co">#             stop("No feature names (rownames) names present in the input matrix")</span></a>
<a class="sourceLine" id="cb1-118" title="118"><span class="co">#         }</span></a>
<a class="sourceLine" id="cb1-119" title="119"><span class="co">#         if (!inherits(x = counts, what = "dgCMatrix")) {</span></a>
<a class="sourceLine" id="cb1-120" title="120"><span class="co">#             counts &lt;- as(object = as.matrix(x = counts), Class = "dgCMatrix")</span></a>
<a class="sourceLine" id="cb1-121" title="121"><span class="co">#         }</span></a>
<a class="sourceLine" id="cb1-122" title="122"><span class="co">#         if (min.features &gt; 0) {</span></a>
<a class="sourceLine" id="cb1-123" title="123"><span class="co">#             nfeatures &lt;- Matrix::colSums(x = counts &gt; 0)</span></a>
<a class="sourceLine" id="cb1-124" title="124"><span class="co">#             counts &lt;- counts[, which(x = nfeatures &gt;= min.features)]</span></a>
<a class="sourceLine" id="cb1-125" title="125"><span class="co">#         }</span></a>
<a class="sourceLine" id="cb1-126" title="126"><span class="co">#         if (min.cells &gt; 0) {</span></a>
<a class="sourceLine" id="cb1-127" title="127"><span class="co">#             num.cells &lt;- Matrix::rowSums(x = counts &gt; 0)</span></a>
<a class="sourceLine" id="cb1-128" title="128"><span class="co">#             counts &lt;- counts[which(x = num.cells &gt;= min.cells), </span></a>
<a class="sourceLine" id="cb1-129" title="129"><span class="co">#                 ]</span></a>
<a class="sourceLine" id="cb1-130" title="130"><span class="co">#         }</span></a>
<a class="sourceLine" id="cb1-131" title="131"><span class="co">#         data &lt;- counts</span></a>
<a class="sourceLine" id="cb1-132" title="132"><span class="co">#     }</span></a>
<a class="sourceLine" id="cb1-133" title="133"><span class="co">#     else if (!missing(x = data)) {</span></a>
<a class="sourceLine" id="cb1-134" title="134"><span class="co">#         if (anyDuplicated(rownames(x = data))) {</span></a>
<a class="sourceLine" id="cb1-135" title="135"><span class="co">#             warning("Non-unique features (rownames) present in the input matrix, making unique", </span></a>
<a class="sourceLine" id="cb1-136" title="136"><span class="co">#                 call. = FALSE, immediate. = TRUE)</span></a>
<a class="sourceLine" id="cb1-137" title="137"><span class="co">#             rownames(x = data) &lt;- make.unique(names = rownames(x = data))</span></a>
<a class="sourceLine" id="cb1-138" title="138"><span class="co">#         }</span></a>
<a class="sourceLine" id="cb1-139" title="139"><span class="co">#         if (anyDuplicated(colnames(x = data))) {</span></a>
<a class="sourceLine" id="cb1-140" title="140"><span class="co">#             warning("Non-unique cell names (colnames) present in the input matrix, making unique", </span></a>
<a class="sourceLine" id="cb1-141" title="141"><span class="co">#                 call. = FALSE, immediate. = TRUE)</span></a>
<a class="sourceLine" id="cb1-142" title="142"><span class="co">#             colnames(x = data) &lt;- make.unique(names = colnames(x = data))</span></a>
<a class="sourceLine" id="cb1-143" title="143"><span class="co">#         }</span></a>
<a class="sourceLine" id="cb1-144" title="144"><span class="co">#         if (is.null(x = colnames(x = data))) {</span></a>
<a class="sourceLine" id="cb1-145" title="145"><span class="co">#             stop("No cell names (colnames) names present in the input matrix")</span></a>
<a class="sourceLine" id="cb1-146" title="146"><span class="co">#         }</span></a>
<a class="sourceLine" id="cb1-147" title="147"><span class="co">#         if (any(rownames(x = data) == "")) {</span></a>
<a class="sourceLine" id="cb1-148" title="148"><span class="co">#             stop("Feature names of data matrix cannot be empty", </span></a>
<a class="sourceLine" id="cb1-149" title="149"><span class="co">#                 call. = FALSE)</span></a>
<a class="sourceLine" id="cb1-150" title="150"><span class="co">#         }</span></a>
<a class="sourceLine" id="cb1-151" title="151"><span class="co">#         if (nrow(x = data) &gt; 0 &amp;&amp; is.null(x = rownames(x = data))) {</span></a>
<a class="sourceLine" id="cb1-152" title="152"><span class="co">#             stop("No feature names (rownames) names present in the input matrix")</span></a>
<a class="sourceLine" id="cb1-153" title="153"><span class="co">#         }</span></a>
<a class="sourceLine" id="cb1-154" title="154"><span class="co">#         if (min.cells != 0 | min.features != 0) {</span></a>
<a class="sourceLine" id="cb1-155" title="155"><span class="co">#             warning("No filtering performed if passing to data rather than counts", </span></a>
<a class="sourceLine" id="cb1-156" title="156"><span class="co">#                 call. = FALSE, immediate. = TRUE)</span></a>
<a class="sourceLine" id="cb1-157" title="157"><span class="co">#         }</span></a>
<a class="sourceLine" id="cb1-158" title="158"><span class="co">#         counts &lt;- new(Class = "matrix")</span></a>
<a class="sourceLine" id="cb1-159" title="159"><span class="co">#     }</span></a>
<a class="sourceLine" id="cb1-160" title="160"><span class="co">#     if (!is.vector(x = rownames(x = counts))) {</span></a>
<a class="sourceLine" id="cb1-161" title="161"><span class="co">#         rownames(x = counts) &lt;- as.vector(x = rownames(x = counts))</span></a>
<a class="sourceLine" id="cb1-162" title="162"><span class="co">#     }</span></a>
<a class="sourceLine" id="cb1-163" title="163"><span class="co">#     if (!is.vector(x = colnames(x = counts))) {</span></a>
<a class="sourceLine" id="cb1-164" title="164"><span class="co">#         colnames(x = counts) &lt;- as.vector(x = colnames(x = counts))</span></a>
<a class="sourceLine" id="cb1-165" title="165"><span class="co">#     }</span></a>
<a class="sourceLine" id="cb1-166" title="166"><span class="co">#     if (!is.vector(x = rownames(x = data))) {</span></a>
<a class="sourceLine" id="cb1-167" title="167"><span class="co">#         rownames(x = data) &lt;- as.vector(x = rownames(x = data))</span></a>
<a class="sourceLine" id="cb1-168" title="168"><span class="co">#     }</span></a>
<a class="sourceLine" id="cb1-169" title="169"><span class="co">#     if (!is.vector(x = colnames(x = data))) {</span></a>
<a class="sourceLine" id="cb1-170" title="170"><span class="co">#         colnames(x = data) &lt;- as.vector(x = colnames(x = data))</span></a>
<a class="sourceLine" id="cb1-171" title="171"><span class="co">#     }</span></a>
<a class="sourceLine" id="cb1-172" title="172"><span class="co">#     if (any(grepl(pattern = "_", x = rownames(x = counts))) || </span></a>
<a class="sourceLine" id="cb1-173" title="173"><span class="co">#         any(grepl(pattern = "_", x = rownames(x = data)))) {</span></a>
<a class="sourceLine" id="cb1-174" title="174"><span class="co">#         warning("Feature names cannot have underscores ('_'), replacing with dashes ('-')", </span></a>
<a class="sourceLine" id="cb1-175" title="175"><span class="co">#             call. = FALSE, immediate. = TRUE)</span></a>
<a class="sourceLine" id="cb1-176" title="176"><span class="co">#         rownames(x = counts) &lt;- gsub(pattern = "_", replacement = "-", </span></a>
<a class="sourceLine" id="cb1-177" title="177"><span class="co">#             x = rownames(x = counts))</span></a>
<a class="sourceLine" id="cb1-178" title="178"><span class="co">#         rownames(x = data) &lt;- gsub(pattern = "_", replacement = "-", </span></a>
<a class="sourceLine" id="cb1-179" title="179"><span class="co">#             x = rownames(x = data))</span></a>
<a class="sourceLine" id="cb1-180" title="180"><span class="co">#     }</span></a>
<a class="sourceLine" id="cb1-181" title="181"><span class="co">#     if (any(grepl(pattern = "|", x = rownames(x = counts), </span></a>
<a class="sourceLine" id="cb1-182" title="182"><span class="co">#         fixed = TRUE)) || any(grepl(pattern = "|", x = rownames(x = data), </span></a>
<a class="sourceLine" id="cb1-183" title="183"><span class="co">#         fixed = TRUE))) {</span></a>
<a class="sourceLine" id="cb1-184" title="184"><span class="co">#         warning("Feature names cannot have pipe characters ('|'), replacing with dashes ('-')", </span></a>
<a class="sourceLine" id="cb1-185" title="185"><span class="co">#             call. = FALSE, immediate. = TRUE)</span></a>
<a class="sourceLine" id="cb1-186" title="186"><span class="co">#         rownames(x = counts) &lt;- gsub(pattern = "|", replacement = "-", </span></a>
<a class="sourceLine" id="cb1-187" title="187"><span class="co">#             x = rownames(x = counts), fixed = TRUE)</span></a>
<a class="sourceLine" id="cb1-188" title="188"><span class="co">#         rownames(x = data) &lt;- gsub(pattern = "|", replacement = "-", </span></a>
<a class="sourceLine" id="cb1-189" title="189"><span class="co">#             x = rownames(x = data), fixed = TRUE)</span></a>
<a class="sourceLine" id="cb1-190" title="190"><span class="co">#     }</span></a>
<a class="sourceLine" id="cb1-191" title="191"><span class="co">#     init.meta.features &lt;- data.frame(row.names = rownames(x = data))</span></a>
<a class="sourceLine" id="cb1-192" title="192"><span class="co">#     assay &lt;- new(Class = "Assay", counts = counts, data = data, </span></a>
<a class="sourceLine" id="cb1-193" title="193"><span class="co">#         scale.data = new(Class = "matrix"), meta.features = init.meta.features)</span></a>
<a class="sourceLine" id="cb1-194" title="194"><span class="co">#     return(assay)</span></a>
<a class="sourceLine" id="cb1-195" title="195"><span class="co"># }</span></a>
<a class="sourceLine" id="cb1-196" title="196"></a>
<a class="sourceLine" id="cb1-197" title="197"><span class="co">###update object to avoid warning.</span></a>
<a class="sourceLine" id="cb1-198" title="198"><span class="kw">data</span>(<span class="st">"pbmc3k"</span>)</a>
<a class="sourceLine" id="cb1-199" title="199">pbmc &lt;-<span class="st"> </span><span class="kw">UpdateSeuratObject</span>(pbmc3k)</a>
<a class="sourceLine" id="cb1-200" title="200"><span class="kw">rm</span>(pbmc3k)</a>
<a class="sourceLine" id="cb1-201" title="201">pbmc</a></code></pre></div>
<pre><code>## An object of class Seurat 
## 13714 features across 2700 samples within 1 assay 
## Active assay: RNA (13714 features)</code></pre>
<h3 id="基本预处理">2. 基本预处理</h3>
<p>作者在原教程说：</p>
<blockquote>
<p>The steps below encompass the standard pre-processing workflow for scRNA-seq data in Seurat. These represent the selection and filtration of cells based on QC metrics, data normalization and scaling, and the detection of highly variable features.</p>
</blockquote>
<h4 id="细胞质控">2.1 细胞质控</h4>
<p>三种基本的QC metrics</p>
<blockquote>
<ol type="1">
<li>The number of unique genes detected in each cell.
<ul>
<li>Low-quality cells or empty droplets will often have very few genes</li>
<li>Cell doublets or multiplets may exhibit an aberrantly high gene count</li>
</ul></li>
<li>Similarly, the total number of molecules detected within a cell (correlates strongly with unique genes)</li>
<li>The percentage of reads that map to the mitochondrial genome
<ul>
<li>Low-quality / dying cells often exhibit extensive mitochondrial contamination</li>
<li>We calculate mitochondrial QC metrics with the <code>PercentageFeatureSet</code> function, which calculates the percentage of counts originating from a set of features</li>
<li>We use the set of all genes starting with <code>MT-</code> as a set of mitochondrial genes</li>
</ul></li>
</ol>
</blockquote>
<p>注意，人的线粒体基因是“MT-”开头，而小鼠的线粒体基因是“mt-”开头</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="co"># The [[ operator can add columns to object metadata. This is a great place to stash QC stats</span></a>
<a class="sourceLine" id="cb3-2" title="2"></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="co">### how does PercentageFeatureSet work</span></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="co"># PercentageFeatureSet</span></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="co"># function (object, pattern = NULL, features = NULL, col.name = NULL, </span></a>
<a class="sourceLine" id="cb3-6" title="6"><span class="co">#     assay = NULL) </span></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="co"># {</span></a>
<a class="sourceLine" id="cb3-8" title="8"><span class="co">#     assay &lt;- assay %||% DefaultAssay(object = object)</span></a>
<a class="sourceLine" id="cb3-9" title="9"><span class="co">#     if (!is.null(x = features) &amp;&amp; !is.null(x = pattern)) {</span></a>
<a class="sourceLine" id="cb3-10" title="10"><span class="co">#         warning("Both pattern and features provided. Pattern is being ignored.")</span></a>
<a class="sourceLine" id="cb3-11" title="11"><span class="co">#     }</span></a>
<a class="sourceLine" id="cb3-12" title="12"><span class="co">#     features &lt;- features %||% grep(pattern = pattern, x = rownames(x = object[[assay]]), </span></a>
<a class="sourceLine" id="cb3-13" title="13"><span class="co">#         value = TRUE)</span></a>
<a class="sourceLine" id="cb3-14" title="14"><span class="co">#     percent.featureset &lt;- colSums(x = GetAssayData(object = object, </span></a>
<a class="sourceLine" id="cb3-15" title="15"><span class="co">#         assay = assay, slot = "counts")[features, , drop = FALSE])/object[[paste0("nCount_", </span></a>
<a class="sourceLine" id="cb3-16" title="16"><span class="co">#         assay)]] * 100</span></a>
<a class="sourceLine" id="cb3-17" title="17"><span class="co">#     if (!is.null(x = col.name)) {</span></a>
<a class="sourceLine" id="cb3-18" title="18"><span class="co">#         object &lt;- AddMetaData(object = object, metadata = percent.featureset, </span></a>
<a class="sourceLine" id="cb3-19" title="19"><span class="co">#             col.name = col.name)</span></a>
<a class="sourceLine" id="cb3-20" title="20"><span class="co">#         return(object)</span></a>
<a class="sourceLine" id="cb3-21" title="21"><span class="co">#     }</span></a>
<a class="sourceLine" id="cb3-22" title="22"><span class="co">#     return(percent.featureset)</span></a>
<a class="sourceLine" id="cb3-23" title="23"><span class="co"># }</span></a>
<a class="sourceLine" id="cb3-24" title="24"></a>
<a class="sourceLine" id="cb3-25" title="25">pbmc[[<span class="st">"percent.mt"</span>]] &lt;-<span class="st"> </span><span class="kw">PercentageFeatureSet</span>(pbmc, <span class="dt">pattern =</span> <span class="st">"^MT-"</span>)</a>
<a class="sourceLine" id="cb3-26" title="26"><span class="co"># Show QC metrics for the first 5 cells</span></a>
<a class="sourceLine" id="cb3-27" title="27"><span class="kw">head</span>(pbmc<span class="op">@</span>meta.data, <span class="dv">5</span>)</a></code></pre></div>
<pre><code>##                orig.ident nCount_RNA nFeature_RNA seurat_annotations percent.mt
## AAACATACAACCAC     pbmc3k       2419          779       Memory CD4 T  3.0177759
## AAACATTGAGCTAC     pbmc3k       4903         1352                  B  3.7935958
## AAACATTGATCAGC     pbmc3k       3147         1129       Memory CD4 T  0.8897363
## AAACCGTGCTTCCG     pbmc3k       2639          960         CD14+ Mono  1.7430845
## AAACCGTGTATGCG     pbmc3k        980          521                 NK  1.2244898</code></pre>
<p>由于我们用的是作者给了metadata的数据，里面已经出现了细胞类型的注释，见<code>seurat_annotation</code>这一项；</p>
<p>QC metric的可视化：</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="co"># Visualize QC metrics as a violin plot</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="kw">VlnPlot</span>(pbmc, <span class="dt">features =</span> <span class="kw">c</span>(<span class="st">"nFeature_RNA"</span>, <span class="st">"nCount_RNA"</span>, <span class="st">"percent.mt"</span>), <span class="dt">ncol =</span> <span class="dv">3</span>)</a></code></pre></div>
<p><img src="/figure/posts/LearnSeurat_PBMC3k_files/figure-gfm/unnamed-chunk-3-1.png" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="co"># FeatureScatter is typically used to visualize feature-feature relationships, but can be used</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="co"># for anything calculated by the object, i.e. columns in object metadata, PC scores etc.</span></a>
<a class="sourceLine" id="cb6-3" title="3"></a>
<a class="sourceLine" id="cb6-4" title="4">plot1 &lt;-<span class="st"> </span><span class="kw">FeatureScatter</span>(pbmc, <span class="dt">feature1 =</span> <span class="st">"nCount_RNA"</span>, <span class="dt">feature2 =</span> <span class="st">"percent.mt"</span>)</a>
<a class="sourceLine" id="cb6-5" title="5">plot2 &lt;-<span class="st"> </span><span class="kw">FeatureScatter</span>(pbmc, <span class="dt">feature1 =</span> <span class="st">"nCount_RNA"</span>, <span class="dt">feature2 =</span> <span class="st">"nFeature_RNA"</span>)</a>
<a class="sourceLine" id="cb6-6" title="6">plot1 <span class="op">+</span><span class="st"> </span>plot2</a></code></pre></div>
<p><img src="/figure/posts/LearnSeurat_PBMC3k_files/figure-gfm/unnamed-chunk-4-1.png" style="display: block; margin: auto;"></p>
<p>最终选择的质控标准为：</p>
<blockquote>
<ul>
<li>We filter cells that have unique feature counts over 2,500 or less than 200</li>
<li>We filter cells that have &gt;5% mitochondrial counts</li>
</ul>
</blockquote>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">pbmc &lt;-<span class="st"> </span><span class="kw">subset</span>(pbmc, <span class="dt">subset =</span> nFeature_RNA <span class="op">&gt;</span><span class="st"> </span><span class="dv">200</span> <span class="op">&amp;</span><span class="st"> </span>nFeature_RNA <span class="op">&lt;</span><span class="st"> </span><span class="dv">2500</span> <span class="op">&amp;</span><span class="st"> </span>percent.mt <span class="op">&lt;</span><span class="st"> </span><span class="dv">5</span>)</a></code></pre></div>
<h4 id="标准化">2.2 标准化</h4>
<blockquote>
<p>After removing unwanted cells from the dataset, the next step is to normalize the data. By default, we employ a global-scaling normalization method “LogNormalize” that normalizes the feature expression measurements for each cell by the total expression, multiplies this by a scale factor (10,000 by default), and log-transforms the result. Normalized values are stored in pbmc[[“RNA”]]<span class="citation" data-cites="data">@data</span>.</p>
</blockquote>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1">pbmc &lt;-<span class="st"> </span><span class="kw">NormalizeData</span>(pbmc, <span class="dt">normalization.method =</span> <span class="st">"LogNormalize"</span>, <span class="dt">scale.factor =</span> <span class="dv">10000</span>)</a></code></pre></div>
<h4 id="特征选择">2.3 特征选择</h4>
<p>哪些基因能反应不同细胞之间的异质性？是那些表达差异大的基因；</p>
<p>注意<code>FindVariableFeatures</code>是S3 generic，泛型函数。 如何查看一个泛型函数的源代码呢，我们先用<code>methods</code>函数匹配该范型函数的名字：</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"><span class="kw">methods</span>(FindVariableFeatures)</a></code></pre></div>
<pre><code>## [1] FindVariableFeatures.Assay*   FindVariableFeatures.default*
## [3] FindVariableFeatures.Seurat* 
## see '?methods' for accessing help and source code</code></pre>
<p>星号表明我们不能直接通过运行函数名字来查看其源代码，但是我们可以通过运行 <strong>getAnywhere</strong>函数来获取这个函数，</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">getAnywhere</span>(FindVariableFeatures.Seurat)</a></code></pre></div>
<pre><code>## A single object matching 'FindVariableFeatures.Seurat' was found
## It was found in the following places
##   registered S3 method for FindVariableFeatures from namespace Seurat
##   namespace:Seurat
## with value
## 
## function (object, assay = NULL, selection.method = "vst", loess.span = 0.3, 
##     clip.max = "auto", mean.function = FastExpMean, dispersion.function = FastLogVMR, 
##     num.bin = 20, binning.method = "equal_width", nfeatures = 2000, 
##     mean.cutoff = c(0.1, 8), dispersion.cutoff = c(1, Inf), verbose = TRUE, 
##     ...) 
## {
##     assay &lt;- assay %||% DefaultAssay(object = object)
##     assay.data &lt;- GetAssay(object = object, assay = assay)
##     assay.data &lt;- FindVariableFeatures(object = assay.data, selection.method = selection.method, 
##         loess.span = loess.span, clip.max = clip.max, mean.function = mean.function, 
##         dispersion.function = dispersion.function, num.bin = num.bin, 
##         binning.method = binning.method, nfeatures = nfeatures, 
##         mean.cutoff = mean.cutoff, dispersion.cutoff = dispersion.cutoff, 
##         verbose = verbose, ...)
##     object[[assay]] &lt;- assay.data
##     object &lt;- LogSeuratCommand(object = object)
##     return(object)
## }
## &lt;bytecode: 0x0000000022fa2410&gt;
## &lt;environment: namespace:Seurat&gt;</code></pre>
<p>我们可以发现，默认的<strong>FindVariableFeatures.Seurat</strong>method调用了<strong>FindVariableFeatures.Assay</strong>：</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"><span class="kw">getAnywhere</span>(FindVariableFeatures.Assay)</a></code></pre></div>
<pre><code>## A single object matching 'FindVariableFeatures.Assay' was found
## It was found in the following places
##   registered S3 method for FindVariableFeatures from namespace Seurat
##   namespace:Seurat
## with value
## 
## function (object, selection.method = "vst", loess.span = 0.3, 
##     clip.max = "auto", mean.function = FastExpMean, dispersion.function = FastLogVMR, 
##     num.bin = 20, binning.method = "equal_width", nfeatures = 2000, 
##     mean.cutoff = c(0.1, 8), dispersion.cutoff = c(1, Inf), verbose = TRUE, 
##     ...) 
## {
##     if (length(x = mean.cutoff) != 2 || length(x = dispersion.cutoff) != 
##         2) {
##         stop("Both 'mean.cutoff' and 'dispersion.cutoff' must be two numbers")
##     }
##     if (selection.method == "vst") {
##         data &lt;- GetAssayData(object = object, slot = "counts")
##         if (IsMatrixEmpty(x = data)) {
##             warning("selection.method set to 'vst' but count slot is empty; will use data slot instead")
##             data &lt;- GetAssayData(object = object, slot = "data")
##         }
##     }
##     else {
##         data &lt;- GetAssayData(object = object, slot = "data")
##     }
##     hvf.info &lt;- FindVariableFeatures(object = data, selection.method = selection.method, 
##         loess.span = loess.span, clip.max = clip.max, mean.function = mean.function, 
##         dispersion.function = dispersion.function, num.bin = num.bin, 
##         binning.method = binning.method, verbose = verbose, ...)
##     object[[names(x = hvf.info)]] &lt;- hvf.info
##     hvf.info &lt;- hvf.info[which(x = hvf.info[, 1, drop = TRUE] != 
##         0), ]
##     if (selection.method == "vst") {
##         hvf.info &lt;- hvf.info[order(hvf.info$vst.variance.standardized, 
##             decreasing = TRUE), , drop = FALSE]
##     }
##     else {
##         hvf.info &lt;- hvf.info[order(hvf.info$mvp.dispersion, decreasing = TRUE), 
##             , drop = FALSE]
##     }
##     selection.method &lt;- switch(EXPR = selection.method, mvp = "mean.var.plot", 
##         disp = "dispersion", selection.method)
##     top.features &lt;- switch(EXPR = selection.method, mean.var.plot = {
##         means.use &lt;- (hvf.info[, 1] &gt; mean.cutoff[1]) &amp; (hvf.info[, 
##             1] &lt; mean.cutoff[2])
##         dispersions.use &lt;- (hvf.info[, 3] &gt; dispersion.cutoff[1]) &amp; 
##             (hvf.info[, 3] &lt; dispersion.cutoff[2])
##         rownames(x = hvf.info)[which(x = means.use &amp; dispersions.use)]
##     }, dispersion = head(x = rownames(x = hvf.info), n = nfeatures), 
##         vst = head(x = rownames(x = hvf.info), n = nfeatures), 
##         stop("Unkown selection method: ", selection.method))
##     VariableFeatures(object = object) &lt;- top.features
##     vf.name &lt;- ifelse(test = selection.method == "vst", yes = "vst", 
##         no = "mvp")
##     vf.name &lt;- paste0(vf.name, ".variable")
##     object[[vf.name]] &lt;- rownames(x = object[[]]) %in% top.features
##     return(object)
## }
## &lt;bytecode: 0x000000002dc5d050&gt;
## &lt;environment: namespace:Seurat&gt;</code></pre>
<p>千层饼的最后一层；</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1"><span class="kw">getAnywhere</span>(FindVariableFeatures.default)</a></code></pre></div>
<pre><code>## A single object matching 'FindVariableFeatures.default' was found
## It was found in the following places
##   registered S3 method for FindVariableFeatures from namespace Seurat
##   namespace:Seurat
## with value
## 
## function (object, selection.method = "vst", loess.span = 0.3, 
##     clip.max = "auto", mean.function = FastExpMean, dispersion.function = FastLogVMR, 
##     num.bin = 20, binning.method = "equal_width", verbose = TRUE, 
##     ...) 
## {
##     CheckDots(...)
##     if (!inherits(x = object, "Matrix")) {
##         object &lt;- as(object = as.matrix(x = object), Class = "Matrix")
##     }
##     if (!inherits(x = object, what = "dgCMatrix")) {
##         object &lt;- as(object = object, Class = "dgCMatrix")
##     }
##     if (selection.method == "vst") {
##         if (clip.max == "auto") {
##             clip.max &lt;- sqrt(x = ncol(x = object))
##         }
##         hvf.info &lt;- data.frame(mean = rowMeans(x = object))
##         hvf.info$variance &lt;- SparseRowVar2(mat = object, mu = hvf.info$mean, 
##             display_progress = verbose)
##         hvf.info$variance.expected &lt;- 0
##         hvf.info$variance.standardized &lt;- 0
##         not.const &lt;- hvf.info$variance &gt; 0
##         fit &lt;- loess(formula = log10(x = variance) ~ log10(x = mean), 
##             data = hvf.info[not.const, ], span = loess.span)
##         hvf.info$variance.expected[not.const] &lt;- 10^fit$fitted
##         hvf.info$variance.standardized &lt;- SparseRowVarStd(mat = object, 
##             mu = hvf.info$mean, sd = sqrt(hvf.info$variance.expected), 
##             vmax = clip.max, display_progress = verbose)
##         colnames(x = hvf.info) &lt;- paste0("vst.", colnames(x = hvf.info))
##     }
##     else {
##         if (!inherits(x = mean.function, what = "function")) {
##             stop("'mean.function' must be a function")
##         }
##         if (!inherits(x = dispersion.function, what = "function")) {
##             stop("'dispersion.function' must be a function")
##         }
##         feature.mean &lt;- mean.function(object, verbose)
##         feature.dispersion &lt;- dispersion.function(object, verbose)
##         names(x = feature.mean) &lt;- names(x = feature.dispersion) &lt;- rownames(x = object)
##         feature.dispersion[is.na(x = feature.dispersion)] &lt;- 0
##         feature.mean[is.na(x = feature.mean)] &lt;- 0
##         data.x.breaks &lt;- switch(EXPR = binning.method, equal_width = num.bin, 
##             equal_frequency = c(-1, quantile(x = feature.mean[feature.mean &gt; 
##                 0], probs = seq.int(from = 0, to = 1, length.out = num.bin))), 
##             stop("Unknown binning method: ", binning.method))
##         data.x.bin &lt;- cut(x = feature.mean, breaks = data.x.breaks)
##         names(x = data.x.bin) &lt;- names(x = feature.mean)
##         mean.y &lt;- tapply(X = feature.dispersion, INDEX = data.x.bin, 
##             FUN = mean)
##         sd.y &lt;- tapply(X = feature.dispersion, INDEX = data.x.bin, 
##             FUN = sd)
##         feature.dispersion.scaled &lt;- (feature.dispersion - mean.y[as.numeric(x = data.x.bin)])/sd.y[as.numeric(x = data.x.bin)]
##         names(x = feature.dispersion.scaled) &lt;- names(x = feature.mean)
##         hvf.info &lt;- data.frame(feature.mean, feature.dispersion, 
##             feature.dispersion.scaled)
##         rownames(x = hvf.info) &lt;- rownames(x = object)
##         colnames(x = hvf.info) &lt;- paste0("mvp.", c("mean", "dispersion", 
##             "dispersion.scaled"))
##     }
##     return(hvf.info)
## }
## &lt;bytecode: 0x0000000023f13fd0&gt;
## &lt;environment: namespace:Seurat&gt;</code></pre>
<p>忽略这些技术细节，进行特征选择；</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1">pbmc &lt;-<span class="st"> </span><span class="kw">FindVariableFeatures</span>(pbmc, <span class="dt">selection.method =</span> <span class="st">"vst"</span>, <span class="dt">nfeatures =</span> <span class="dv">2000</span>)</a>
<a class="sourceLine" id="cb17-2" title="2"></a>
<a class="sourceLine" id="cb17-3" title="3"><span class="co"># Identify the 10 most highly variable genes</span></a>
<a class="sourceLine" id="cb17-4" title="4">top10 &lt;-<span class="st"> </span><span class="kw">head</span>(<span class="kw">VariableFeatures</span>(pbmc), <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb17-5" title="5"></a>
<a class="sourceLine" id="cb17-6" title="6"><span class="co"># plot variable features with and without labels</span></a>
<a class="sourceLine" id="cb17-7" title="7">plot1 &lt;-<span class="st"> </span><span class="kw">VariableFeaturePlot</span>(pbmc)</a>
<a class="sourceLine" id="cb17-8" title="8">plot2 &lt;-<span class="st"> </span><span class="kw">LabelPoints</span>(<span class="dt">plot =</span> plot1, <span class="dt">points =</span> top10, <span class="dt">repel =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb17-9" title="9">plot1 <span class="op">+</span><span class="st"> </span>plot2</a></code></pre></div>
<p><img src="/figure/posts/LearnSeurat_PBMC3k_files/figure-gfm/unnamed-chunk-11-1.png" style="display: block; margin: auto;"></p>
<h4 id="scaling-the-data">2.4 Scaling the data</h4>
<p>这步的目的是为了后续的PCA：</p>
<blockquote>
<p>Next, we apply a linear transformation (‘scaling’) that is a standard pre-processing step prior to dimensional reduction techniques like PCA. The <strong>ScaleData</strong> function: + Shifts the expression of each gene, so that the mean expression across cells is 0 + Scales the expression of each gene, so that the variance across cells is 1 + This step gives equal weight in downstream analyses, so that highly-expressed genes do not dominate + The results of this are stored in <strong>pbmc[[“RNA”]]<span class="citation" data-cites="scale.data">@scale.data</span></strong></p>
</blockquote>
<p>回归掉percent.mt对于PCA的影响。这步是一步限速步骤；</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1">all.genes &lt;-<span class="st"> </span><span class="kw">rownames</span>(pbmc)</a>
<a class="sourceLine" id="cb18-2" title="2">pbmc &lt;-<span class="st"> </span><span class="kw">ScaleData</span>(pbmc, <span class="dt">features =</span> all.genes,<span class="dt">vars.to.regress =</span> <span class="st">"percent.mt"</span>)</a></code></pre></div>
<p>有一个问题后面的marker基因一定是HVG吗？</p>
<h4 id="线性降维pca">2.5 线性降维(PCA)</h4>
<blockquote>
<p>Next we perform PCA on the scaled data. By default, only the previously determined variable features are used as input, but can be defined using features argument if you wish to choose a different subset.</p>
</blockquote>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1">pbmc &lt;-<span class="st"> </span><span class="kw">RunPCA</span>(pbmc, <span class="dt">features =</span> <span class="kw">VariableFeatures</span>(<span class="dt">object =</span> pbmc))</a>
<a class="sourceLine" id="cb19-2" title="2"><span class="co"># Examine and visualize PCA results a few different ways</span></a>
<a class="sourceLine" id="cb19-3" title="3"><span class="kw">print</span>(pbmc[[<span class="st">"pca"</span>]], <span class="dt">dims =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, <span class="dt">nfeatures =</span> <span class="dv">5</span>)</a></code></pre></div>
<pre><code>## PC_ 1 
## Positive:  CST3, TYROBP, LST1, AIF1, FTL 
## Negative:  MALAT1, LTB, IL32, IL7R, CD2 
## PC_ 2 
## Positive:  CD79A, MS4A1, TCL1A, HLA-DQA1, HLA-DQB1 
## Negative:  NKG7, PRF1, CST7, GZMA, GZMB 
## PC_ 3 
## Positive:  HLA-DQA1, CD79A, CD79B, HLA-DQB1, HLA-DPA1 
## Negative:  PPBP, PF4, SDPR, SPARC, GNG11 
## PC_ 4 
## Positive:  HLA-DQA1, CD79B, CD79A, MS4A1, HLA-DQB1 
## Negative:  VIM, IL7R, S100A6, S100A8, IL32 
## PC_ 5 
## Positive:  GZMB, FGFBP2, S100A8, NKG7, GNLY 
## Negative:  LTB, IL7R, CKB, MS4A7, RP11-290F20.3</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1"><span class="kw">VizDimLoadings</span>(pbmc, <span class="dt">dims =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dt">reduction =</span> <span class="st">"pca"</span>)</a></code></pre></div>
<p><img src="/figure/posts/LearnSeurat_PBMC3k_files/figure-gfm/unnamed-chunk-14-1.png" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1"><span class="kw">DimPlot</span>(pbmc, <span class="dt">reduction =</span> <span class="st">"pca"</span>)</a></code></pre></div>
<p><img src="/figure/posts/LearnSeurat_PBMC3k_files/figure-gfm/unnamed-chunk-15-1.png" style="display: block; margin: auto;"></p>
<blockquote>
<p>In particular <strong>DimHeatmap</strong> allows for easy exploration of the primary sources of heterogeneity in a dataset, and can be useful when trying to decide which PCs to include for further downstream analyses. Both cells and features are ordered according to their PCA scores. Setting cells to a number plots the ‘extreme’ cells on both ends of the spectrum, which dramatically speeds plotting for large datasets. Though clearly a supervised analysis, we find this to be a valuable tool for exploring correlated feature sets.</p>
</blockquote>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" title="1"><span class="co">###     Plot an equal number of genes with both + and - scores.</span></a>
<a class="sourceLine" id="cb23-2" title="2">mypal &lt;-<span class="st"> </span><span class="kw">rev</span>(<span class="kw">colorRampPalette</span>(RColorBrewer<span class="op">::</span><span class="kw">brewer.pal</span>(<span class="dv">11</span>,<span class="st">"RdBu"</span>))(<span class="dv">256</span>))</a>
<a class="sourceLine" id="cb23-3" title="3"><span class="kw">DimHeatmap</span>(pbmc, <span class="dt">dims =</span> <span class="dv">1</span>, <span class="dt">cells =</span> <span class="dv">500</span>, <span class="dt">balanced =</span> <span class="ot">TRUE</span>,<span class="dt">fast =</span> F)<span class="op">+</span><span class="kw">scale_fill_gradientn</span>(<span class="dt">colors  =</span> mypal)</a></code></pre></div>
<p><img src="/figure/posts/LearnSeurat_PBMC3k_files/figure-gfm/unnamed-chunk-16-1.png" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" title="1"><span class="kw">DimHeatmap</span>(pbmc, <span class="dt">dims =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">15</span>, <span class="dt">cells =</span> <span class="dv">500</span>, <span class="dt">balanced =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p><img src="/figure/posts/LearnSeurat_PBMC3k_files/figure-gfm/unnamed-chunk-17-1.png" style="display: block; margin: auto;"></p>
<h4 id="determine-the-dimensionality-of-the-dataset">2.6 Determine the ‘dimensionality’ of the dataset</h4>
<blockquote>
<p>To overcome the extensive technical noise in any single feature for scRNA-seq data, Seurat clusters cells based on their PCA scores, with each PC essentially representing a ‘metafeature’ that combines information across a correlated feature set. The top principal components therefore represent a robust compression of the dataset. However, how many componenets should we choose to include? 10? 20? 100?</p>
</blockquote>
<p>两种统计方法，<code>JackStraw</code>和<code>ElbowPlot</code>，前者比较耗时，不再展示了，用后者</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" title="1"><span class="kw">ElbowPlot</span>(pbmc)</a></code></pre></div>
<p><img src="/figure/posts/LearnSeurat_PBMC3k_files/figure-gfm/unnamed-chunk-18-1.png" style="display: block; margin: auto;"></p>
<p>作者给出了更进一步的解释</p>
<blockquote>
<p>Identifying the true dimensionality of a dataset – can be challenging/uncertain for the user. We therefore suggest these three approaches to consider. The first is more supervised, exploring PCs to determine relevant sources of heterogeneity, and could be used in conjunction with GSEA for example. The second implements a statistical test based on a random null model, but is time-consuming for large datasets, and may not return a clear PC cutoff. The third is a heuristic that is commonly used, and can be calculated instantly. In this example, all three approaches yielded similar results, but we might have been justified in choosing anything between PC 7-12 as a cutoff.</p>
</blockquote>
<blockquote>
<p>We chose 10 here, but encourage users to consider the following:</p>
</blockquote>
<blockquote>
<ul>
<li>Dendritic cell and NK aficionados may recognize that genes strongly associated with PCs 12 and 13 define rare immune subsets (i.e. MZB1 is a marker for plasmacytoid DCs). However, these groups are so rare, they are difficult to distinguish from background noise for a dataset of this size without prior knowledge.</li>
<li>We encourage users to repeat downstream analyses with a different number of PCs (10, 15, or even 50!). As you will observe, the results often do not differ dramatically.</li>
<li>We advise users to err on the higher side when choosing this parameter. For example, performing downstream analyses with only 5 PCs does signifcanltly and adversely affect results.</li>
</ul>
</blockquote>
<h3 id="后续分析">3. 后续分析</h3>
<h4 id="聚类">3.1 聚类</h4>
<p><strong>FindNeighbors</strong>构建构建SNN-graph, 而<strong>FindClusters</strong>用来实现Louvain algorithm，进行图聚类；</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" title="1"><span class="kw">methods</span>(FindNeighbors)</a></code></pre></div>
<pre><code>## [1] FindNeighbors.Assay*   FindNeighbors.default* FindNeighbors.dist*   
## [4] FindNeighbors.Seurat* 
## see '?methods' for accessing help and source code</code></pre>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" title="1"><span class="kw">getAnywhere</span>(FindNeighbors.Seurat)</a></code></pre></div>
<pre><code>## A single object matching 'FindNeighbors.Seurat' was found
## It was found in the following places
##   registered S3 method for FindNeighbors from namespace Seurat
##   namespace:Seurat
## with value
## 
## function (object, reduction = "pca", dims = 1:10, assay = NULL, 
##     features = NULL, k.param = 20, compute.SNN = TRUE, prune.SNN = 1/15, 
##     nn.method = "rann", annoy.metric = "euclidean", nn.eps = 0, 
##     verbose = TRUE, force.recalc = FALSE, do.plot = FALSE, graph.name = NULL, 
##     ...) 
## {
##     CheckDots(...)
##     if (!is.null(x = dims)) {
##         assay &lt;- DefaultAssay(object = object[[reduction]])
##         data.use &lt;- Embeddings(object = object[[reduction]])
##         if (max(dims) &gt; ncol(x = data.use)) {
##             stop("More dimensions specified in dims than have been computed")
##         }
##         data.use &lt;- data.use[, dims]
##         neighbor.graphs &lt;- FindNeighbors(object = data.use, k.param = k.param, 
##             compute.SNN = compute.SNN, prune.SNN = prune.SNN, 
##             nn.method = nn.method, annoy.metric = annoy.metric, 
##             nn.eps = nn.eps, verbose = verbose, force.recalc = force.recalc, 
##             ...)
##     }
##     else {
##         assay &lt;- assay %||% DefaultAssay(object = object)
##         data.use &lt;- GetAssay(object = object, assay = assay)
##         neighbor.graphs &lt;- FindNeighbors(object = data.use, features = features, 
##             k.param = k.param, compute.SNN = compute.SNN, prune.SNN = prune.SNN, 
##             nn.method = nn.method, annoy.metric = annoy.metric, 
##             nn.eps = nn.eps, verbose = verbose, force.recalc = force.recalc, 
##             ...)
##     }
##     graph.name &lt;- graph.name %||% paste0(assay, "_", names(x = neighbor.graphs))
##     for (ii in 1:length(x = graph.name)) {
##         DefaultAssay(object = neighbor.graphs[[ii]]) &lt;- assay
##         object[[graph.name[[ii]]]] &lt;- neighbor.graphs[[ii]]
##     }
##     if (do.plot) {
##         if (!"tsne" %in% names(x = object@reductions)) {
##             warning("Please compute a tSNE for SNN visualization. See RunTSNE().")
##         }
##         else {
##             if (nrow(x = Embeddings(object = object[["tsne"]])) != 
##                 ncol(x = object)) {
##                 warning("Please compute a tSNE for SNN visualization. See RunTSNE().")
##             }
##             else {
##                 net &lt;- graph.adjacency(adjmatrix = as.matrix(x = neighbor.graphs[[2]]), 
##                   mode = "undirected", weighted = TRUE, diag = FALSE)
##                 plot.igraph(x = net, layout = as.matrix(x = Embeddings(object = object[["tsne"]])), 
##                   edge.width = E(graph = net)$weight, vertex.label = NA, 
##                   vertex.size = 0)
##             }
##         }
##     }
##     object &lt;- LogSeuratCommand(object = object)
##     return(object)
## }
## &lt;bytecode: 0x000000001e49f8e0&gt;
## &lt;environment: namespace:Seurat&gt;</code></pre>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" title="1">pbmc &lt;-<span class="st"> </span><span class="kw">FindNeighbors</span>(pbmc, <span class="dt">dims =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb30-2" title="2">pbmc &lt;-<span class="st"> </span><span class="kw">FindClusters</span>(pbmc, <span class="dt">resolution =</span> <span class="fl">0.5</span>)</a></code></pre></div>
<pre><code>## Modularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck
## 
## Number of nodes: 2638
## Number of edges: 95930
## 
## Running Louvain algorithm...
## Maximum modularity in 10 random starts: 0.8737
## Number of communities: 9
## Elapsed time: 0 seconds</code></pre>
<h4 id="run-umaptsne">3.2 Run UMAP/tsne</h4>
<p>run tsne</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" title="1">pbmc &lt;-<span class="st"> </span><span class="kw">RunTSNE</span>(pbmc,<span class="dt">dims =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb32-2" title="2"><span class="kw">DimPlot</span>(pbmc,<span class="dt">label =</span> T, <span class="dt">reduction =</span> <span class="st">"tsne"</span>)</a></code></pre></div>
<p><img src="/figure/posts/LearnSeurat_PBMC3k_files/figure-gfm/unnamed-chunk-22-1.png" style="display: block; margin: auto;"></p>
<p>draw snn graph on tsne-embeding</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" title="1">test &lt;-<span class="st"> </span>pbmc[[<span class="st">"RNA_snn"</span>]]</a>
<a class="sourceLine" id="cb33-2" title="2"></a>
<a class="sourceLine" id="cb33-3" title="3"></a>
<a class="sourceLine" id="cb33-4" title="4">net &lt;-<span class="st"> </span><span class="kw">graph.adjacency</span>(<span class="dt">adjmatrix =</span> <span class="kw">as.matrix</span>(<span class="dt">x =</span> test), </a>
<a class="sourceLine" id="cb33-5" title="5">                  <span class="dt">mode =</span> <span class="st">"undirected"</span>, <span class="dt">weighted =</span> <span class="ot">TRUE</span>, </a>
<a class="sourceLine" id="cb33-6" title="6">                  <span class="dt">diag =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb33-7" title="7"><span class="kw">plot.igraph</span>(<span class="dt">x =</span> net, </a>
<a class="sourceLine" id="cb33-8" title="8">            <span class="dt">layout =</span> <span class="kw">as.matrix</span>(<span class="dt">x =</span> <span class="kw">Embeddings</span>(<span class="dt">object =</span> pbmc[[<span class="st">"tsne"</span>]])),</a>
<a class="sourceLine" id="cb33-9" title="9">            <span class="dt">edge.width =</span> <span class="kw">E</span>(<span class="dt">graph =</span> net)<span class="op">$</span>weight, <span class="dt">vertex.label =</span> <span class="ot">NA</span>, </a>
<a class="sourceLine" id="cb33-10" title="10">                  <span class="dt">vertex.size =</span> <span class="dv">0</span>)</a></code></pre></div>
<p><img src="/figure/posts/LearnSeurat_PBMC3k_files/figure-gfm/unnamed-chunk-23-1.png" style="display: block; margin: auto;"></p>
<p>run umap</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" title="1"><span class="co"># If you haven't installed UMAP, you can do so via reticulate::py_install(packages =</span></a>
<a class="sourceLine" id="cb34-2" title="2"><span class="co"># 'umap-learn')</span></a>
<a class="sourceLine" id="cb34-3" title="3">pbmc &lt;-<span class="st"> </span><span class="kw">RunUMAP</span>(pbmc,<span class="dt">umap.method =</span> <span class="st">"umap-learn"</span>, <span class="dt">dims =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb34-4" title="4"><span class="co"># note that you can set `label = TRUE` or use the LabelClusters function to help label</span></a>
<a class="sourceLine" id="cb34-5" title="5"><span class="co"># individual clusters</span></a>
<a class="sourceLine" id="cb34-6" title="6"><span class="kw">DimPlot</span>(pbmc,<span class="dt">label =</span> T, <span class="dt">reduction =</span> <span class="st">"umap"</span>)</a></code></pre></div>
<p><img src="/figure/posts/LearnSeurat_PBMC3k_files/figure-gfm/unnamed-chunk-24-1.png" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" title="1">test &lt;-<span class="st"> </span>pbmc[[<span class="st">"RNA_snn"</span>]]</a>
<a class="sourceLine" id="cb35-2" title="2"></a>
<a class="sourceLine" id="cb35-3" title="3">net &lt;-<span class="st"> </span><span class="kw">graph.adjacency</span>(<span class="dt">adjmatrix =</span> <span class="kw">as.matrix</span>(<span class="dt">x =</span> test), </a>
<a class="sourceLine" id="cb35-4" title="4">                  <span class="dt">mode =</span> <span class="st">"undirected"</span>, <span class="dt">weighted =</span> <span class="ot">TRUE</span>, </a>
<a class="sourceLine" id="cb35-5" title="5">                  <span class="dt">diag =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb35-6" title="6"><span class="kw">plot.igraph</span>(<span class="dt">x =</span> net, </a>
<a class="sourceLine" id="cb35-7" title="7">            <span class="dt">layout =</span> <span class="kw">as.matrix</span>(<span class="dt">x =</span> <span class="kw">Embeddings</span>(<span class="dt">object =</span> pbmc[[<span class="st">"umap"</span>]])),</a>
<a class="sourceLine" id="cb35-8" title="8">            <span class="dt">edge.width =</span> <span class="kw">E</span>(<span class="dt">graph =</span> net)<span class="op">$</span>weight, <span class="dt">vertex.label =</span> <span class="ot">NA</span>, </a>
<a class="sourceLine" id="cb35-9" title="9">                  <span class="dt">vertex.size =</span> <span class="dv">0</span>)</a></code></pre></div>
<p><img src="/figure/posts/LearnSeurat_PBMC3k_files/figure-gfm/unnamed-chunk-25-1.png" style="display: block; margin: auto;"></p>
<h4 id="finding-differentially-expressed-features-cluster-biomarkers">3.3 Finding differentially expressed features (cluster biomarkers)</h4>
<p>之前分群结果做差异表达；</p>
<blockquote>
<p>Seurat can help you find markers that define clusters via differential expression. By default, it identifes positive and negative markers of a single cluster (specified in <strong>ident.1</strong>), compared to all other cells. <strong>FindAllMarkers</strong> automates this process for all clusters, but you can also test groups of clusters vs. each other, or against all cells.</p>
</blockquote>
<blockquote>
<p>The <strong>min.pct</strong> argument requires a feature to be detected at a minimum percentage in either of the two groups of cells, and the thresh.test argument requires a feature to be differentially expressed (on average) by some amount between the two groups. You can set both of these to 0, but with a dramatic increase in time - since this will test a large number of features that are unlikely to be highly discriminatory. As another option to speed up these computations, <strong>max.cells.per.ident</strong> can be set. This will downsample each identity class to have no more cells than whatever this is set to. While there is generally going to be a loss in power, the speed increases can be significiant and the most highly differentially expressed features will likely still rise to the top.</p>
</blockquote>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" title="1"><span class="co"># find markers for every cluster compared to all remaining cells, report only the positive ones</span></a>
<a class="sourceLine" id="cb36-2" title="2">pbmc.markers &lt;-<span class="st"> </span><span class="kw">FindAllMarkers</span>(pbmc, <span class="dt">only.pos =</span> <span class="ot">TRUE</span>, <span class="dt">min.pct =</span> <span class="fl">0.25</span>, <span class="dt">logfc.threshold =</span> <span class="fl">0.25</span>)</a>
<a class="sourceLine" id="cb36-3" title="3">pbmc.markers <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(cluster) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">top_n</span>(<span class="dt">n =</span> <span class="dv">2</span>, <span class="dt">wt =</span> avg_logFC)</a></code></pre></div>
<pre><code>## # A tibble: 18 x 7
## # Groups:   cluster [9]
##        p_val avg_logFC pct.1 pct.2 p_val_adj cluster gene    
##        &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt; &lt;fct&gt;   &lt;chr&gt;   
##  1 1.88e-117     0.748 0.913 0.588 2.57e-113 0       LDHB    
##  2 5.01e- 85     0.931 0.437 0.108 6.88e- 81 0       CCR7    
##  3 0.            3.86  0.996 0.215 0.        1       S100A9  
##  4 0.            3.80  0.975 0.121 0.        1       S100A8  
##  5 2.61e- 81     0.886 0.981 0.65  3.58e- 77 2       LTB     
##  6 1.22e- 59     0.886 0.669 0.25  1.68e- 55 2       CD2     
##  7 0.            2.99  0.939 0.042 0.        3       CD79A   
##  8 1.06e-269     2.49  0.623 0.022 1.45e-265 3       TCL1A   
##  9 5.98e-221     2.23  0.987 0.226 8.20e-217 4       CCL5    
## 10 1.42e-173     2.08  0.572 0.051 1.94e-169 4       GZMK    
## 11 3.51e-184     2.30  0.975 0.134 4.82e-180 5       FCGR3A  
## 12 2.03e-125     2.14  1     0.315 2.78e-121 5       LST1    
## 13 3.17e-267     3.35  0.961 0.068 4.35e-263 6       GZMB    
## 14 1.04e-189     3.66  0.961 0.132 1.43e-185 6       GNLY    
## 15 1.48e-220     2.68  0.812 0.011 2.03e-216 7       FCER1A  
## 16 1.67e- 21     1.99  1     0.513 2.28e- 17 7       HLA-DPB1
## 17 7.73e-200     5.02  1     0.01  1.06e-195 8       PF4     
## 18 3.68e-110     5.94  1     0.024 5.05e-106 8       PPBP</code></pre>
<p>可视化：</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" title="1"><span class="kw">VlnPlot</span>(pbmc, <span class="dt">features =</span> <span class="kw">c</span>(<span class="st">"MS4A1"</span>, <span class="st">"CD79A"</span>))</a></code></pre></div>
<p><img src="/figure/posts/LearnSeurat_PBMC3k_files/figure-gfm/unnamed-chunk-27-1.png" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" title="1"><span class="co"># you can plot raw counts as well</span></a>
<a class="sourceLine" id="cb39-2" title="2"><span class="kw">VlnPlot</span>(pbmc, <span class="dt">features =</span> <span class="kw">c</span>(<span class="st">"MS4A1"</span>, <span class="st">"CD79A"</span>), <span class="dt">slot =</span> <span class="st">"counts"</span>, <span class="dt">log =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p><img src="/figure/posts/LearnSeurat_PBMC3k_files/figure-gfm/unnamed-chunk-28-1.png" style="display: block; margin: auto;"></p>
<p>使用<strong>FeatureScatter</strong>获得和流式图一样的效果；</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" title="1"><span class="kw">FeatureScatter</span>(<span class="dt">object =</span> pbmc,</a>
<a class="sourceLine" id="cb40-2" title="2">               <span class="dt">feature1 =</span> <span class="st">"MS4A1"</span>,</a>
<a class="sourceLine" id="cb40-3" title="3">               <span class="dt">feature2 =</span> <span class="st">"CD79A"</span>)<span class="op">+</span></a>
<a class="sourceLine" id="cb40-4" title="4"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="dt">label =</span> <span class="ot">NULL</span>)</a></code></pre></div>
<p><img src="/figure/posts/LearnSeurat_PBMC3k_files/figure-gfm/unnamed-chunk-29-1.png" style="display: block; margin: auto;"></p>
<p>用<strong>FeaturePlot</strong>在Embeding上展示表达量；</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" title="1"><span class="kw">FeaturePlot</span>(pbmc, <span class="dt">features =</span> <span class="kw">c</span>(<span class="st">"MS4A1"</span>, <span class="st">"GNLY"</span>, <span class="st">"CD3E"</span>, <span class="st">"CD14"</span>, <span class="st">"FCER1A"</span>, <span class="st">"FCGR3A"</span>, <span class="st">"LYZ"</span>, <span class="st">"PPBP"</span>, </a>
<a class="sourceLine" id="cb41-2" title="2">    <span class="st">"CD8A"</span>))</a></code></pre></div>
<p><img src="/figure/posts/LearnSeurat_PBMC3k_files/figure-gfm/unnamed-chunk-30-1.png" style="display: block; margin: auto;"></p>
<p>气泡图<strong>DotPlot</strong></p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" title="1"><span class="kw">DotPlot</span>(<span class="dt">object =</span> pbmc,</a>
<a class="sourceLine" id="cb42-2" title="2">        <span class="dt">features =</span> <span class="kw">c</span>(<span class="st">"MS4A1"</span>, <span class="st">"GNLY"</span>, <span class="st">"CD3E"</span>, <span class="st">"CD14"</span>, <span class="st">"FCER1A"</span>, <span class="st">"FCGR3A"</span>, <span class="st">"LYZ"</span>, <span class="st">"PPBP"</span>,  <span class="st">"CD8A"</span>))<span class="op">+</span></a>
<a class="sourceLine" id="cb42-3" title="3"><span class="st">  </span><span class="kw">coord_flip</span>()</a></code></pre></div>
<p><img src="/figure/posts/LearnSeurat_PBMC3k_files/figure-gfm/unnamed-chunk-31-1.png" style="display: block; margin: auto;"></p>
<p><strong>RidgePlot</strong></p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb43-1" title="1"><span class="kw">RidgePlot</span>(<span class="dt">object =</span> pbmc,</a>
<a class="sourceLine" id="cb43-2" title="2">          <span class="dt">features =</span> <span class="kw">c</span>(<span class="st">"MS4A1"</span>, <span class="st">"GNLY"</span>, <span class="st">"CD3E"</span>, <span class="st">"CD14"</span>, <span class="st">"FCER1A"</span>, <span class="st">"FCGR3A"</span>, <span class="st">"LYZ"</span>, <span class="st">"PPBP"</span>,  <span class="st">"CD8A"</span>))</a></code></pre></div>
<p><img src="/figure/posts/LearnSeurat_PBMC3k_files/figure-gfm/unnamed-chunk-32-1.png" style="display: block; margin: auto;"></p>
<p>热图<strong>DoHeatmap</strong></p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" title="1">top10 &lt;-<span class="st"> </span>pbmc.markers <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb44-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(cluster) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">top_n</span>(<span class="dt">n =</span> <span class="dv">10</span>, <span class="dt">wt =</span> avg_logFC)</a>
<a class="sourceLine" id="cb44-3" title="3"></a>
<a class="sourceLine" id="cb44-4" title="4"><span class="kw">DoHeatmap</span>(pbmc, <span class="dt">features =</span> top10<span class="op">$</span>gene) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb44-5" title="5"><span class="st">  </span><span class="kw">scale_fill_gradientn</span>(<span class="dt">colors  =</span> mypal)</a></code></pre></div>
<p><img src="/figure/posts/LearnSeurat_PBMC3k_files/figure-gfm/unnamed-chunk-33-1.png" style="display: block; margin: auto;"></p>
<h4 id="assigning-cell-type-identity-to-clusters">3.4 Assigning cell type identity to clusters</h4>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb45-1" title="1">new.cluster.ids &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"Naive CD4 T"</span>,<span class="st">"CD14+ Mono"</span>, <span class="st">"Memory CD4 T"</span>,  <span class="st">"B"</span>, <span class="st">"CD8 T"</span>, <span class="st">"FCGR3A+ Mono"</span>, <span class="st">"NK"</span>, <span class="st">"DC"</span>, <span class="st">"Platelet"</span>)</a>
<a class="sourceLine" id="cb45-2" title="2"><span class="kw">names</span>(new.cluster.ids) &lt;-<span class="st"> </span><span class="kw">levels</span>(pbmc)</a>
<a class="sourceLine" id="cb45-3" title="3">pbmc &lt;-<span class="st"> </span><span class="kw">RenameIdents</span>(pbmc, new.cluster.ids)</a>
<a class="sourceLine" id="cb45-4" title="4"><span class="kw">DimPlot</span>(pbmc, <span class="dt">reduction =</span> <span class="st">"umap"</span>, <span class="dt">label =</span> <span class="ot">TRUE</span>, <span class="dt">pt.size =</span> <span class="fl">0.5</span>) <span class="op">+</span><span class="st"> </span><span class="kw">NoLegend</span>()</a></code></pre></div>
<p><img src="/figure/posts/LearnSeurat_PBMC3k_files/figure-gfm/unnamed-chunk-34-1.png" style="display: block; margin: auto;"></p>
<h3 id="seurat-object-详解">4. Seurat object 详解</h3>
<p>这一部分来自wiki</p>
<h4 id="the-seurat-object">4.1 The Seurat object</h4>
<p>一个Seurat对象有如下的<code>slots</code>:</p>
<table>
<colgroup>
<col style="width: 15%">
<col style="width: 84%">
</colgroup>
<thead>
<tr class="header">
<th>Slot</th>
<th>Function</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>assays</code></td>
<td>A list of assays within this object</td>
</tr>
<tr class="even">
<td><code>meta.data</code></td>
<td>Cell-level meta data</td>
</tr>
<tr class="odd">
<td><code>active.assay</code></td>
<td>Name of active, or default, assay</td>
</tr>
<tr class="even">
<td><code>active.ident</code></td>
<td>Identity classes for the current object</td>
</tr>
<tr class="odd">
<td><code>graphs</code></td>
<td>A list of nearest neighbor graphs</td>
</tr>
<tr class="even">
<td><code>reductions</code></td>
<td>A list of DimReduc objects</td>
</tr>
<tr class="odd">
<td><code>project.name</code></td>
<td>User-defined project name (optional)</td>
</tr>
<tr class="even">
<td><code>tools</code></td>
<td>Empty list. Tool developers can store any internal data from their methods here</td>
</tr>
<tr class="odd">
<td><code>misc</code></td>
<td>Empty slot. User can store additional information here</td>
</tr>
<tr class="even">
<td><code>version</code></td>
<td>Seurat version used when creating the object</td>
</tr>
</tbody>
</table>
<p>这个对象把单细胞数据的所有的基本信息都包含进去了，可以用基本的一些函数去获取这些信息。例如，我们想要知道这个数据对应多少细胞，多少基因，可以用<code>dim</code>;<code>ncol</code>;<code>nrow</code>;细胞或者feature的名字，可以用<code>rownames</code>;<code>colnames</code>; 我们也可以通过<code>names</code>知道里面存储的如原始表达矩阵，或者降维后对象的名字。</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" title="1"><span class="kw">names</span>(<span class="dt">x =</span> pbmc)</a></code></pre></div>
<pre><code>## [1] "RNA"     "RNA_nn"  "RNA_snn" "pca"     "tsne"    "umap"</code></pre>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb48-1" title="1">rna &lt;-<span class="st"> </span>pbmc[[<span class="st">'RNA'</span>]]</a></code></pre></div>
<p>对于Seurat对象，有一系列的函数可以对其进行操作。这些函数可以称为其所属的<strong>methods</strong>。多说一句，Seurat采取的是S3对象的面向对象的数据结构。</p>
<p>可以使用如下命令访问与Seurat对象相关的操作。</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb49-1" title="1">utils<span class="op">::</span><span class="kw">methods</span>(<span class="dt">class =</span> <span class="st">'Seurat'</span>)</a></code></pre></div>
<pre><code>##  [1] $                       $&lt;-                     [                      
##  [4] [[                      [[&lt;-                    AddMetaData            
##  [7] as.CellDataSet          as.loom                 as.SingleCellExperiment
## [10] Command                 DefaultAssay            DefaultAssay&lt;-         
## [13] dim                     dimnames                droplevels             
## [16] Embeddings              FindClusters            FindMarkers            
## [19] FindNeighbors           FindVariableFeatures    GetAssay               
## [22] GetAssayData            HVFInfo                 Idents                 
## [25] Idents&lt;-                Key                     levels                 
## [28] levels&lt;-                Loadings                merge                  
## [31] Misc                    Misc&lt;-                  names                  
## [34] NormalizeData           OldWhichCells           Project                
## [37] Project&lt;-               RenameCells             RenameIdents           
## [40] ReorderIdent            RunALRA                 RunCCA                 
## [43] RunICA                  RunLSI                  RunPCA                 
## [46] RunTSNE                 RunUMAP                 ScaleData              
## [49] ScoreJackStraw          SetAssayData            SetIdent               
## [52] show                    StashIdent              Stdev                  
## [55] subset                  SubsetData              Tool                   
## [58] Tool&lt;-                  VariableFeatures        VariableFeatures&lt;-     
## [61] WhichCells             
## see '?methods' for accessing help and source code</code></pre>
<h4 id="assay">4.2 Assay</h4>
<blockquote>
<p>The <code>Assay</code> class stores single cell data.</p>
</blockquote>
<blockquote>
<p>For typical scRNA-seq experiments, a Seurat object will have a single Assay (“RNA”). This assay will also store multiple ‘transformations’ of the data, including raw counts (<span class="citation" data-cites="counts">@counts</span> slot), normalized data (<span class="citation" data-cites="data">@data</span> slot), and scaled data for dimensional reduction (<span class="citation" data-cites="scale.data">@scale.data</span> slot).</p>
</blockquote>
<blockquote>
<p>For more complex experiments, an object could contain multiple assays. These could include multi-modal data types (CITE-seq antibody-derived tags, ADTs), or imputed/batch-corrected measurements. Each of those assays has the option to store the same data transformations as well.</p>
</blockquote>
<p>一个<strong>Assay</strong> 所含有的Slots</p>
<table>
<colgroup>
<col style="width: 16%">
<col style="width: 83%">
</colgroup>
<thead>
<tr class="header">
<th>Slot</th>
<th>Function</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>counts</code></td>
<td>Stores unnormalized data such as raw counts or TPMs</td>
</tr>
<tr class="even">
<td><code>data</code></td>
<td>Normalized data matrix</td>
</tr>
<tr class="odd">
<td><code>scale.data</code></td>
<td>Scaled data matrix</td>
</tr>
<tr class="even">
<td><code>key</code></td>
<td>A character string to facilitate looking up features from a specific <code>Assay</code></td>
</tr>
<tr class="odd">
<td><code>var.features</code></td>
<td>A vector of features identified as variable</td>
</tr>
<tr class="even">
<td><code>meta.features</code></td>
<td>Feature-level meta data</td>
</tr>
</tbody>
</table>
<p><strong>Assay</strong>对象也可以使用以下方法</p>
<p>Summary information about <code>Assay</code> objects can be had quickly and easily using standard R functions. Object shape/dimensions can be found using the <code>dim</code>, <code>ncol</code>, and <code>nrow</code> functions; cell and feature names can be found using the <code>colnames</code> and <code>rownames</code> functions, respectively, or the <code>dimnames</code> function.</p>
<p>更多的方法见</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb51-1" title="1">utils<span class="op">::</span><span class="kw">methods</span>(<span class="dt">class =</span> <span class="st">'Assay'</span>)</a></code></pre></div>
<pre><code>##  [1] [                    [[                   [[&lt;-                
##  [4] AddMetaData          DefaultAssay         DefaultAssay&lt;-      
##  [7] dim                  dimnames             FindNeighbors       
## [10] FindVariableFeatures GetAssayData         HVFInfo             
## [13] Key                  Key&lt;-                merge               
## [16] Misc                 Misc&lt;-               NormalizeData       
## [19] OldWhichCells        RenameCells          RunICA              
## [22] RunLSI               RunPCA               ScaleData           
## [25] SetAssayData         show                 subset              
## [28] SubsetData           VariableFeatures     VariableFeatures&lt;-  
## [31] WhichCells          
## see '?methods' for accessing help and source code</code></pre>
<p>Data Access</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb53-1" title="1"><span class="co"># GetAssayData allows pulling from a specific slot rather than just data</span></a>
<a class="sourceLine" id="cb53-2" title="2"><span class="kw">GetAssayData</span>(<span class="dt">object =</span> rna, <span class="dt">slot =</span> <span class="st">'scale.data'</span>)[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>]</a></code></pre></div>
<pre><code>##               AAACATACAACCAC AAACATTGAGCTAC AAACATTGATCAGC
## AL627309.1       -0.06433822    -0.06968772    -0.04966479
## AP006222.2       -0.02663018    -0.02065038    -0.04303249
## RP11-206L10.2    -0.03015459    -0.02024084    -0.05734758</code></pre>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb55-1" title="1"><span class="kw">head</span>(<span class="dt">x =</span> <span class="kw">HVFInfo</span>(<span class="dt">object =</span> rna,<span class="dt">selection.method =</span> <span class="st">"vst"</span>))</a></code></pre></div>
<pre><code>##                      mean    variance variance.standardized
## AL627309.1    0.003411676 0.003401325             0.9330441
## AP006222.2    0.001137225 0.001136363             0.9924937
## RP11-206L10.2 0.001895375 0.001892500             0.9627290
## RP11-206L10.9 0.001137225 0.001136363             0.9924937
## LINC00115     0.006823351 0.006779363             0.9062135
## NOC2L         0.107278241 0.159514698             0.7849309</code></pre>
<p>The key</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb57-1" title="1"><span class="co"># Key both accesses and sets the key slot for an Assay object</span></a>
<a class="sourceLine" id="cb57-2" title="2"><span class="op">&gt;</span><span class="st"> </span><span class="kw">Key</span>(<span class="dt">object =</span> rna)</a>
<a class="sourceLine" id="cb57-3" title="3"><span class="st">"rna_"</span></a>
<a class="sourceLine" id="cb57-4" title="4"><span class="op">&gt;</span><span class="st"> </span><span class="kw">Key</span>(<span class="dt">object =</span> rna) &lt;-<span class="st"> 'myRNA_'</span></a>
<a class="sourceLine" id="cb57-5" title="5"><span class="op">&gt;</span><span class="st"> </span><span class="kw">Key</span>(<span class="dt">object =</span> rna)</a>
<a class="sourceLine" id="cb57-6" title="6"><span class="st">"myRNA_"</span></a>
<a class="sourceLine" id="cb57-7" title="7"><span class="co"># Pull a feature from the RNA assay on the Seurat level</span></a>
<a class="sourceLine" id="cb57-8" title="8"><span class="op">&gt;</span><span class="st"> </span><span class="kw">head</span>(<span class="dt">x =</span> <span class="kw">FetchData</span>(<span class="dt">object =</span> pbmc, <span class="dt">vars.fetch =</span> <span class="st">'rna_MS4A1'</span>))</a>
<a class="sourceLine" id="cb57-9" title="9">               rna_MS4A1</a>
<a class="sourceLine" id="cb57-10" title="10">AAACATACAACCAC  <span class="fl">0.000000</span></a>
<a class="sourceLine" id="cb57-11" title="11">AAACATTGAGCTAC  <span class="fl">2.583047</span></a>
<a class="sourceLine" id="cb57-12" title="12">AAACATTGATCAGC  <span class="fl">0.000000</span></a>
<a class="sourceLine" id="cb57-13" title="13">AAACCGTGCTTCCG  <span class="fl">0.000000</span></a>
<a class="sourceLine" id="cb57-14" title="14">AAACCGTGTATGCG  <span class="fl">0.000000</span></a>
<a class="sourceLine" id="cb57-15" title="15">AAACGCACTGGTAC  <span class="fl">0.000000</span></a></code></pre></div>
<p>The <code>DimReduc</code> object represents a dimensional reduction taken upon the Seurat object.</p>
<h4 id="the-dimreduc-object">4.3 The <code>DimReduc</code> object</h4>
<p>The <code>DimReduc</code> object represents a dimensional reduction taken upon the Seurat object.</p>
<table>
<colgroup>
<col style="width: 26%">
<col style="width: 73%">
</colgroup>
<thead>
<tr class="header">
<th>Slot</th>
<th>Function</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>cell.embeddings</code></td>
<td>A matrix with cell embeddings</td>
</tr>
<tr class="even">
<td><code>feature.loadings</code></td>
<td>A matrix with feature loadings</td>
</tr>
<tr class="odd">
<td><code>feature.loadings.projected</code></td>
<td>A matrix with projected feature loadings</td>
</tr>
<tr class="even">
<td><code>assay.used</code></td>
<td>Assay used to calculate this dimensional reduction</td>
</tr>
<tr class="odd">
<td><code>stdev</code></td>
<td>Standard deviation for the dimensional reduction</td>
</tr>
<tr class="even">
<td><code>key</code></td>
<td>A character string to facilitate looking up features from a specific <code>DimReduc</code></td>
</tr>
<tr class="odd">
<td><code>jackstraw</code></td>
<td>Results from the <code>JackStraw</code> function</td>
</tr>
<tr class="even">
<td><code>misc</code></td>
<td>…</td>
</tr>
</tbody>
</table>
<p>和之前的很类似</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb58-1" title="1">pca &lt;-<span class="st"> </span>pbmc[[<span class="st">"pca"</span>]]</a>
<a class="sourceLine" id="cb58-2" title="2"><span class="co"># The following examples use the PCA dimensional reduction from the PBMC 3k dataset</span></a>
<a class="sourceLine" id="cb58-3" title="3"><span class="op">&gt;</span><span class="st"> </span>pca</a>
<a class="sourceLine" id="cb58-4" title="4">A dimensional reduction object with key PC</a>
<a class="sourceLine" id="cb58-5" title="5"> Number of dimensions<span class="op">:</span><span class="st"> </span><span class="dv">20</span></a>
<a class="sourceLine" id="cb58-6" title="6"> Projected dimensional reduction calculated<span class="op">:</span><span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb58-7" title="7"> Jackstraw run<span class="op">:</span><span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb58-8" title="8"><span class="co"># nrow and ncol provide the number of features and cells, respectively</span></a>
<a class="sourceLine" id="cb58-9" title="9"><span class="co"># dim provides both nrow and ncol at the same time</span></a>
<a class="sourceLine" id="cb58-10" title="10"><span class="op">&gt;</span><span class="st"> </span><span class="kw">dim</span>(<span class="dt">x =</span> pca)</a>
<a class="sourceLine" id="cb58-11" title="11">[<span class="dv">1</span>] <span class="dv">1838</span> <span class="dv">2638</span></a>
<a class="sourceLine" id="cb58-12" title="12"><span class="co"># length provides the number of dimensions calculated</span></a>
<a class="sourceLine" id="cb58-13" title="13"><span class="op">&gt;</span><span class="st"> </span><span class="kw">length</span>(<span class="dt">x =</span> pca)</a>
<a class="sourceLine" id="cb58-14" title="14">[<span class="dv">1</span>] <span class="dv">20</span></a>
<a class="sourceLine" id="cb58-15" title="15"><span class="co"># In addtion to rownames and colnames, one can use dimnames</span></a>
<a class="sourceLine" id="cb58-16" title="16"><span class="co"># which provides a two-length list with both rownames and colnames</span></a>
<a class="sourceLine" id="cb58-17" title="17"><span class="op">&gt;</span><span class="st"> </span><span class="kw">head</span>(<span class="dt">x =</span> <span class="kw">rownames</span>(<span class="dt">x =</span> rna))</a>
<a class="sourceLine" id="cb58-18" title="18">[<span class="dv">1</span>] <span class="st">"TNFRSF4"</span>  <span class="st">"CPSF3L"</span>   <span class="st">"ATAD3C"</span>   <span class="st">"C1orf86"</span>  <span class="st">"RER1"</span>     <span class="st">"TNFRSF25"</span></a>
<a class="sourceLine" id="cb58-19" title="19"><span class="op">&gt;</span><span class="st"> </span><span class="kw">head</span>(<span class="dt">x =</span> <span class="kw">colnames</span>(<span class="dt">x =</span> rna))</a>
<a class="sourceLine" id="cb58-20" title="20">[<span class="dv">1</span>] <span class="st">"AAACATACAACCAC"</span> <span class="st">"AAACATTGAGCTAC"</span> <span class="st">"AAACATTGATCAGC"</span> <span class="st">"AAACCGTGCTTCCG"</span></a>
<a class="sourceLine" id="cb58-21" title="21">[<span class="dv">5</span>] <span class="st">"AAACCGTGTATGCG"</span> <span class="st">"AAACGCACTGGTAC"</span></a></code></pre></div>
<p>Access data</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb59-1" title="1"><span class="co"># The key can be used to pull cell embeddings for specific dimensions from the Seurat level</span></a>
<a class="sourceLine" id="cb59-2" title="2"><span class="op">&gt;</span><span class="st"> </span><span class="kw">Key</span>(<span class="dt">object =</span> pca)</a>
<a class="sourceLine" id="cb59-3" title="3"><span class="st">"PC"</span></a>
<a class="sourceLine" id="cb59-4" title="4"><span class="op">&gt;</span><span class="st"> </span><span class="kw">head</span>(<span class="dt">x =</span> <span class="kw">FetchData</span>(<span class="dt">object =</span> pbmc, <span class="dt">vars.fetch =</span> <span class="st">'PC1'</span>))</a>
<a class="sourceLine" id="cb59-5" title="5">                      PC1</a>
<a class="sourceLine" id="cb59-6" title="6">AAACATACAACCAC   <span class="fl">5.569384</span></a>
<a class="sourceLine" id="cb59-7" title="7">AAACATTGAGCTAC   <span class="fl">7.216456</span></a>
<a class="sourceLine" id="cb59-8" title="8">AAACATTGATCAGC   <span class="fl">2.706629</span></a>
<a class="sourceLine" id="cb59-9" title="9">AAACCGTGCTTCCG <span class="fl">-10.134042</span></a>
<a class="sourceLine" id="cb59-10" title="10">AAACCGTGTATGCG  <span class="fl">-1.099311</span></a>
<a class="sourceLine" id="cb59-11" title="11">AAACGCACTGGTAC   <span class="fl">1.455335</span></a>
<a class="sourceLine" id="cb59-12" title="12"><span class="co"># DefaultAssay gets the name of the Assay object used to calculate the DimReduc</span></a>
<a class="sourceLine" id="cb59-13" title="13"><span class="op">&gt;</span><span class="st"> </span><span class="kw">DefaultAssay</span>(<span class="dt">object =</span> pca)</a>
<a class="sourceLine" id="cb59-14" title="14">[<span class="dv">1</span>] <span class="st">"RNA"</span></a>
<a class="sourceLine" id="cb59-15" title="15"><span class="co"># Stdev gets the vector of standard deviations for each dimension embedded.</span></a>
<a class="sourceLine" id="cb59-16" title="16"><span class="kw">Stdev</span>(<span class="dt">object =</span> pca)</a>
<a class="sourceLine" id="cb59-17" title="17"> [<span class="dv">1</span>] <span class="fl">5.666584</span> <span class="fl">4.326466</span> <span class="fl">3.952192</span> <span class="fl">3.638124</span> <span class="fl">2.191529</span> <span class="fl">1.996551</span> <span class="fl">1.877891</span> <span class="fl">1.798251</span></a>
<a class="sourceLine" id="cb59-18" title="18"> [<span class="dv">9</span>] <span class="fl">1.766873</span> <span class="fl">1.753684</span> <span class="fl">1.731568</span> <span class="fl">1.720525</span> <span class="fl">1.718079</span> <span class="fl">1.715879</span> <span class="fl">1.707009</span> <span class="fl">1.702660</span></a>
<a class="sourceLine" id="cb59-19" title="19">[<span class="dv">17</span>] <span class="fl">1.697318</span> <span class="fl">1.692549</span> <span class="fl">1.686149</span> <span class="fl">1.683967</span></a></code></pre></div>
<p>在其上可以执行的<strong>method</strong>有</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb60-1" title="1">utils<span class="op">::</span><span class="kw">methods</span>(<span class="dt">class =</span> <span class="st">"DimReduc"</span>)</a></code></pre></div>
<pre><code>##  [1] [              [[             Cells          DefaultAssay   DefaultAssay&lt;-
##  [6] dim            dimnames       Embeddings     IsGlobal       JS            
## [11] JS&lt;-           Key            Key&lt;-          length         Loadings      
## [16] Loadings&lt;-     names          print          RenameCells    RunTSNE       
## [21] ScoreJackStraw show           Stdev          subset        
## see '?methods' for accessing help and source code</code></pre>
<h4 id="r面向对象编程的更多细节">4.4 R面向对象编程的更多细节；</h4>
<p>关于面向对象，以及S3对象的教程，更多可见：</p>
<ol type="1">
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/31160374">R深入|面向对象——泛型函数</a></li>
<li><a target="_blank" rel="noopener" href="http://adv-r.had.co.nz/OO-essentials.html">OO field guide</a></li>
<li><a target="_blank" rel="noopener" href="https://dataxujing.github.io/R_oop/">R语言面向对象编程</a></li>
</ol>
<svg style="display: none" id="MJX-SVG-global-cache"><defs></defs></svg>
            
                

            
        </div>
        <div class="post-tool">
            <a class="btn-thumbs-up" href="javascript:void(0);" data-cid="52" title="95">
                <i class="fa fa-thumbs-up" aria-hidden="true"></i> 打赏
            </a>
        </div>
        
        <div class="post-tags">标签：
            
            <a href="/tags/R/">R</a>
            
            <a href="/tags/scRNA-seq/">scRNA-seq</a>
            
        </div>
        
    </article>
    
        <p style="text-align: center">本文代表个人观点，内容仅供参考。若有不恰当之处，望不吝赐教！</p>
    
    
    

</div>

<script src="/js/busuanzi.pure.mini.js"></script>



        </div><!-- end #main-->
    </div><!-- end #body -->
    <footer class="footer">
    <div class="footer-inner" style="text-align: 'center'">
        <p>
            <a href="/about"  title="关于">关于</a>&nbsp;&nbsp<em>·</em>&nbsp;&nbsp
            <!-- 自定义链接 -->
            <a href="/help" title="帮助" >帮助</a>&nbsp;&nbsp<em>·</em>&nbsp;&nbsp
            <a href="/links" title="友链">友链</a>&nbsp;&nbsp<em>·</em>&nbsp;&nbsp
            <a href="/sitemap.xml" title="地图">地图</a>
        </p>
        <p>
            本站已建立&nbsp<a href="/timeline" id="siteBuildingTime"></a>&nbsp天，<a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="licence">采用知识共享署名-相同方式共享 4.0 国际许可协议创作</a><br/>
            ©2017-<span id="cpYear"></span> 基于&nbsp<a href="http://hexo.io" target="_blank" rel="nofollow">Hexo</a>
            ，主题采用&nbsp&nbsp<a href="https://github.com/tangkunyin/hexo-theme-jsimple" target="_blank" rel="bookmark">JSimple</a>
            ，作者&nbsp<a href="https://landau1994.github.io" target="_blank" rel="friend">landau1994</a>
            ，Hosted by <a href="https://pages.github.com/" target="_blank" rel="nofollow">GitHub Pages</a>
        </p>
    </div>
</footer>

<script src="/js/SimpleCore.js"></script>


</div>
<!-- search pop -->
<div class="popup search-popup local-search-popup">
    <div class="local-search-header clearfix">
        <span class="search-icon">
            <i class="fa fa-search"></i>
        </span>
        <span class="popup-btn-close">
            <i class="fa fa-times-circle"></i>
        </span>
        <div class="local-search-input-wrapper">
            <input id="local-search-input"
                   spellcheck="false"
                   type="text"
                   autocomplete="off"
                   placeholder="请输入查询关键词"/>
        </div>
    </div>
    <div id="local-search-result"></div>
</div>
<div class="fixed-btn">
    <a class="btn-gotop" href="javascript:"> <i class="fa fa-angle-up"></i></a>
</div>
<script>
    $(function () {
        var jsi_config = {
            buildingTime: '08/01/2018',
            current: $('.post-tags').length > 0 ? 'post' : 'archive',
            snsQRCode: '/images/sns-qrcode.png',
            donateImg: '/images/donate-qr.png',
            localSearch: { dbPath: '' },
            readMode: 'day'
        };
        
            jsi_config.localSearch = {
                dbPath: '/search.json',
                trigger: 'auto',
                topN: '1',
                unescape: 'false'
            }
        
        SimpleCore.init(jsi_config);
        
    });
</script>
</body>
</html>
